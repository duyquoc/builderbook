<div id="chapter-content" style="padding: 20px 10%; background-color: white; color: black;"><h2 style="font-weight: 400; line-height: 1.5em; background-color: white; color: black;">Chapter 8: BuyButton component. Buy book logic. ReadChapter page. Checkout flow. MyBooks page. Mailchimp API. Deploy app.</h2><div style="background-color: white; color: black;"><hr>
<ul>
<li>BuyButton component <br></li>
</ul>
<ul>
<li>Buy book logic <br><ul>
<li>API method buyBook()</li>
<li>Express route '/buy-book'</li>
<li>Static method Book.buy()</li>
<li>stripeCharge() function</li>
<li>Purchase model</li>
</ul>
</li>
</ul>
<ul>
<li>ReadChapter page  <br><ul>
<li>Excerpt and full content</li>
<li>BuyButton</li>
<li>Testing</li>
</ul>
</li>
</ul>
<ul>
<li>Checkout flow <br></li>
</ul>
<ul>
<li>MyBooks page <br><ul>
<li>API method getMyBookList()</li>
<li>Express route '/my-books'</li>
<li>Static method Book.getPurchasedBooks()</li>
</ul>
</li>
</ul>
<ul>
<li>Mailchimp API <br></li>
</ul>
<ul>
<li>Deploy app <br><ul>
<li>Prepare server</li>
<li>Env keys</li>
<li>Admin user</li>
<li>Now</li>
</ul>
</li>
</ul>
<hr>
<p>Before you start working on Chapter 8, get the <code>8-begin</code> codebase. The <a target="_blank" href="https://github.com/builderbook/builderbook/tree/master/book/8-begin" rel="noopener noreferrer">8-begin</a> folder is located at the root of the <code>book</code> directory inside the <a target="_blank" href="https://github.com/builderbook/builderbook" rel="noopener noreferrer">builderbook repo</a>.</p>
<ul>
<li>If you haven't cloned the builderbook repo yet, clone it to your local machine with <code>git clone https://github.com/builderbook/builderbook.git</code>.</li>
<li>Inside the <code>8-begin</code> folder, run <code>yarn</code> to install all packages. </li>
</ul>
<p>These are the packages that we install specifically for Chapter 8:</p>
<ul>
<li><code>"compression"</code></li>
<li><code>"helmet"</code></li>
<li><code>"htmlescape"</code></li>
<li><code>"react-stripe-checkout"</code></li>
<li><code>"sitemap"</code></li>
<li><code>"stripe"</code></li>
</ul>
<p>Check out the <a target="_blank" href="https://github.com/builderbook/builderbook/blob/master/book/8-begin/package.json" rel="noopener noreferrer">package.json</a> for Chapter 8.</p>
<ul>
<li>Be sure to use these specific packages and ignore any warnings about upgrading. We regularly upgrade all packages and test them in the book. But before testing, we cannot guarantee that a new package version will work properly.</li>
</ul>
<p>Remember to include your <code>.env</code> at the root of your app. By the end of Chapter 8, you will add:</p>
<ul>
<li><code>Stripe_Test_SecretKey</code> and <code>Stripe_Live_SecretKey</code>,</li>
<li><code>Stripe_Test_PublishableKey</code> and <code>Stripe_Live_PublishableKey</code>,</li>
<li><code>MAILCHIMP_API_KEY</code>,<code>MAILCHIMP_REGION</code>, and <code>MAILCHIMP_PURCHASED_LIST_ID</code> environmental variables to your <code>.env</code> file. </li>
</ul>
<hr>
<br>

<p>In the previous chapter (Chapter 7), we made many UX improvements to our <code>ReadChapter</code> page. In this chapter, we will add all code related to selling a book. Here is a high-level overview of what we want to accomplish:</p>
<ul>
<li>introduce a <code>BuyButton</code> component</li>
<li>define all necessary code to make the buy button functional: API method, Express route, and static methods for our Book model, Stripe API, and Purchase model</li>
<li>add a <code>BuyButton</code> component to our <code>ReadChapter</code> page and test the checkout flow</li>
<li>show books that a user bought on the <code>MyBooks</code> page (user dashboard)</li>
<li>add the email of a user who bought a book to a mailing list on Mailchimp</li>
</ul>
<p>Like with any other new feature that needs to GET or POST data, the flow of data is usually as follows:</p>
<ul>
<li>there is a <em>page or component</em> that calls an <em>API method</em></li>
<li>the <em>API method</em> sends a request to a particular route, which executes a matching <em>Express route</em></li>
<li>the function inside the matching <em>Express route</em> calls a static method for a model, waits for data, and returns data to the client</li>
</ul>
<p>By using this blueprint above, we've already implemented data exchange between client and server many times in this book. In Chapters 5 and 6, we added many pages/components, API methods, Express routes, and static methods related to our Admin user. In this section, we will write code related to our <em>Customer</em> user, who buys and reads a book.</p>
<p>Our first step, as per the blueprint, is to create a <code>BuyButton</code> component that we eventually import and add to our <code>ReadChapter</code> page. Inside this component, we will call the <code>buyBook()</code> API method.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="buybutton-component" href="#buybutton-component" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="buybutton-component">
          BuyButton component
        </span>
      </h2><p>In Chapter 2, we wrote our <code>Header</code> component as a stateless functional component (<a target="_blank" href="https://builderbook.org/books/builder-book/server-database-session-header-and-menudrop-components#update-header-component" rel="noopener noreferrer">link</a>) and <code>MenuDrop</code> component as a regular component (<a target="_blank" href="https://builderbook.org/books/builder-book/server-database-session-header-and-menudrop-components#menudrop-component" rel="noopener noreferrer">link</a>).</p>
<p>The <code>BuyButton</code> component will have both props and state. Thus, we should write it as a regular component. Check out <code>components/MenuDrop.js</code> to remember how we write regular components. To define our new <code>BuyButton</code> component with ES6 class:</p>
<pre>class BuyButton extends React.Component { ... }</pre>

<p>We export a single value with <a target="_blank" href="https://developer.mozilla.org/en-US/docs/web/javascript/reference/statements/export#Using_the_default_export" rel="noopener noreferrer">default export</a>:</p>
<pre>export default BuyButton</pre>

<p>Since the <code>BuyButton</code> component is for our Customer user only, create a <code>components/customer/BuyButton.js</code> file.<br>The carcass of the <code>BuyButton</code> component with all necessary imports is:<br><code>components/customer/BuyButton.js</code> :</p>
<pre><code><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>;
<span class="hljs-keyword">import</span> StripeCheckout <span class="hljs-keyword">from</span> <span class="hljs-string">'react-stripe-checkout'</span>;
<span class="hljs-keyword">import</span> NProgress <span class="hljs-keyword">from</span> <span class="hljs-string">'nprogress'</span>;

<span class="hljs-keyword">import</span> Button <span class="hljs-keyword">from</span> <span class="hljs-string">'@material-ui/core/Button'</span>;

<span class="hljs-keyword">import</span> { buyBook } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/api/customer'</span>;
<span class="hljs-keyword">import</span> notify <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/notifier'</span>;

<span class="hljs-keyword">const</span> styleBuyButton = {
  <span class="hljs-attr">margin</span>: <span class="hljs-string">'20px 20px 20px 0px'</span>,
  <span class="hljs-attr">font</span>: <span class="hljs-string">'14px Muli'</span>,
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BuyButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  <span class="hljs-comment">// 1. propTypes and defaultProps</span>

  <span class="hljs-comment">// 2. constructor (set initial state)</span>

  <span class="hljs-comment">// 3. onToken function</span>

  <span class="hljs-comment">// 4. onLoginClicked function</span>

  render() {
    <span class="hljs-comment">// 5. define variables with props and state</span>

    <span class="hljs-keyword">if</span> (!book) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">return</span> (
        <span class="hljs-comment">// 6. Regular button with onClick={this.onLoginClicked} event handler</span>
      );
    }

    <span class="hljs-keyword">return</span> (
      <span class="hljs-comment">// 7. StripeCheckout button with token and stripeKey parameters</span>
    );
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> BuyButton;</code></pre><p>We discuss all code snippets in detail below.</p>
<ol>
<li><p>When we wrote our <code>Header</code> component as a stateless function (<code>components/Header.js</code>), we used <code>Header.propTypes</code> to specify types of props. But when we define a regular component with ES6 class, we specify types of props with <code>static propTypes</code>. For our <code>BuyButton</code> component, we should use the latter method, since we defined this component as a child ES6 class <code>class BuyButton extends React.Component</code>. You get:</p>
<pre><code><span class="hljs-string">static</span> <span class="hljs-string">defaultProps</span> <span class="hljs-string">=</span> <span class="hljs-string">{</span>
<span class="hljs-attr"> book:</span> <span class="hljs-literal">null</span><span class="hljs-string">,</span>
<span class="hljs-attr"> user:</span> <span class="hljs-literal">null</span><span class="hljs-string">,</span>
<span class="hljs-attr"> showModal:</span> <span class="hljs-literal">false</span><span class="hljs-string">,</span>
<span class="hljs-string">};</span></code></pre><p>We will define and use these three props later in this section.</p>
</li>
<li><p>Similar to how there are two ways to specify types of props, there are two popular ways to set initial state. When you don't use a prop to set an initial state object, you can simply write the following <em>without</em> using <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/constructor" rel="noopener noreferrer">constructor</a>:</p>
<pre><code><span class="hljs-keyword">state</span> = {
 open: false,
 <span class="hljs-built_in">anchor</span>El: undefined,
};</code></pre><p>We discussed <code>constructor</code> usage cases in detail in <a target="_blank" href="https://builderbook.org/books/builder-book/server-database-session-header-and-menudrop-components#menudrop-component" rel="noopener noreferrer">Chapter 2</a> and <a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#readchapter-page" rel="noopener noreferrer">Chapter 5</a>.</p>
<p>Open <code>components/MenuDrop.js</code> to see how this was done for our <code>MenuDrop</code> component.</p>
<p>However, in the case of our <code>BuyButton</code> component, we want to use a <code>showModal</code> prop to set the initial state. Thus, we should use <code>constuctor</code>:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">constructor</span><span class="hljs-params">(props)</span> <span class="hljs-comment">{
 super(props);

 this.state = {
   showModal: !!props.showModal,
 }</span>;</span>
}</code></pre><p>Later in this chapter, we plan to pass a <code>showModal</code> prop from the <code>ReadChapter</code> page to our <code>BuyButton</code> component. <code>showModal: !!props.showModal</code> ensures that when <code>showModal</code> is true in the <code>ReadChapter</code> page, then <code>showModal</code> is true in the <code>BuyButton</code> component as well.</p>
<p>As we discussed <a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#page" rel="noopener noreferrer">in Chapter 5</a>, calling <code>super(props)</code> makes props available inside constructor.</p>
</li>
<li><p>As discussed earlier in this book (<a target="_blank" href="https://builderbook.org/books/builder-book/app-structure-next-js-hoc-material-ui-server-side-rendering-styles#server-side-rendering" rel="noopener noreferrer">Chapter 1, SSR</a>) - for SSR, we call an API method inside <code>getInitialProps()</code>; for CSR, we call an API method inside <code>componentDidMount()</code> or inside an event-handling function.</p>
<p>In the <code>BuyButton</code> component, we want to call a <code>buyBook()</code> API method after our user <em>takes an action</em> (clicks the buy button). So we defintely don't want to do SSR and execute this <code>buyBook()</code> API method on the server. To execute <code>buyBook()</code> on the client, we would <em>normally</em> place <code>buyBook()</code> inside <code>componentDidMount()</code>. However, if placed inside <code>componentDidMount()</code>, this API method will be called <em>right after the component mounts</em> on the client. This is not what we want - we want to call our API method <em>on a click event</em>. Thus, we place <code>buyBook()</code> inside an <code>onToken</code> function that gets executed after a user clicks the buy button.</p>
<p>We will point <code>onToken</code> to an async anonymous function and use the <code>try/catch</code> construct along with <code>async/await</code> (as we did many times before in this book). If you want to refresh your memory, <a target="_blank" href="https://builderbook.org/books/builder-book/authentication-hoc-promise-async-await-static-method-for-user-model-google-oauth#async-await" rel="noopener noreferrer">check out Chapter 3</a>. Let's write an async anonymous function that calls the <code>buyBook()</code> API method and uses <code>Nprogress</code> and <code>notify()</code> to communicate success to our user. You should get:</p>
<pre><code>onToken = async<span class="hljs-function"> (<span class="hljs-params">token</span>) =&gt;</span> {
 <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NProgress</span>.</span></span>start<span class="hljs-literal">()</span>;
 const { book } = this.props;
 this.set<span class="hljs-constructor">State({ <span class="hljs-params">showModal</span>: <span class="hljs-params">false</span> })</span>;

 <span class="hljs-keyword">try</span> {
   await buy<span class="hljs-constructor">Book({ <span class="hljs-params">stripeToken</span>: <span class="hljs-params">token</span>, <span class="hljs-params">id</span>: <span class="hljs-params">book</span>.<span class="hljs-params">_id</span> })</span>;
   notify('Success!');
   <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NProgress</span>.</span></span><span class="hljs-keyword">done</span><span class="hljs-literal">()</span>;
 } catch (err) {
   <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NProgress</span>.</span></span><span class="hljs-keyword">done</span><span class="hljs-literal">()</span>;
   notify(err);
 }
};</code></pre><p>When a user clicks the <code>BuyButton</code> component, our code calls the <code>onToken</code> function.</p>
<p>We pass <code>book</code> prop from the <code>ReadChapter</code> page to the <code>BuyButton</code> component. (We'll discuss this more in the next section when we add <code>BuyButton</code> to <code>ReadChapter</code>.) Thus, constant <code>book</code> is defined as <code>this.props.book</code>. Using ES6 object destructuring:</p>
<pre>const { book } = this.props</pre>

<p>After a user clicks the buy button, we want to close the modal (Stripe modal with a form for card details):</p>
<pre>this.setState({ showModal: false })</pre>

<p>Then the code calls and waits for successful execution of our API method <code>buyBook()</code> that takes two arguments:</p>
<pre>await buyBook({ stripeToken: token, id: book._id });</pre>

<p>At this point, the rest of the code should be self-explanatory.</p>
</li>
<li><p>Why do we need an <code>onLoginClicked</code> function? If a user is logged in, then we simply call the <code>onToken</code> function and <code>buyBook()</code> API method. However, if a user is <em>not</em> logged in, we want to redirect the user to the <code>/auth/google</code> route (Google OAuth).</p>
<p>Similar to the <code>book</code> prop, we pass the <code>user</code> prop from our <code>ReadChapter</code> page to the <code>BuyButton</code> component:</p>
<pre>const { user } = this.props</pre>

<p>We check if a <code>user</code> object exists, and it if does not exist or is empty, we redirect to Google OAuth:</p>
<pre><code><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">user</span>) {
 <span class="hljs-keyword">window</span>.<span class="hljs-keyword">location</span>.href = <span class="hljs-string">'/auth/google'</span>;
}</code></pre><p>Put these two snippets together and you define <code>onLoginClicked</code>:</p>
<pre><code><span class="hljs-function"><span class="hljs-title">onLoginClicked</span> = <span class="hljs-params">()</span> =&gt;</span> {
 const { user } = <span class="hljs-keyword">this</span>.props;

 <span class="hljs-keyword">if</span> (!user) {
   <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/auth/google'</span>;
 }
};</code></pre></li>
<li><p>Define <code>book</code> and <code>user</code> constants (<a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/const" rel="noopener noreferrer">block-scoped variables</a>) as <code>this.props.book</code> and <code>this.props.user</code>, respectively. Also define the <code>showModal</code> constant as <code>this.state.showModal</code>. Using ES6 object destructuring:</p>
<pre><code>const { book,<span class="hljs-built_in"> user </span>} = this.props;
const { showModal } = this.state;</code></pre></li>
<li><p>If a user is <em>not</em> logged in, we simply show a button from Material-UI. This button has an <code>onClick</code> event handler that points to <code>{this.onLoginClicked}</code>:</p>
<pre><code><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
   <span class="hljs-attr">variant</span>=<span class="hljs-string">"contained"</span>
   <span class="hljs-attr">style</span>=</span></span><span class="hljs-template-variable">{styleBuyButton}</span><span class="xml"><span class="hljs-tag">
   <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span>
   <span class="hljs-attr">onClick</span>=</span></span><span class="hljs-template-variable">{this.onLoginClicked}</span><span class="xml"><span class="hljs-tag">
 &gt;</span>
   Buy for $</span><span class="hljs-template-variable">{book.price}</span><span class="xml">
 <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></code></pre></li>
<li><p>If a user is logged in, we again show a button, but now we wrap it with <code>&lt;StripeCheckout&gt;...&lt;/StripeCheckout&gt;</code> from the <a target="_blank" href="https://github.com/azmenak/react-stripe-checkout" rel="noopener noreferrer">react-stripe-checkout</a> package.</p>
<p>Take a look at this <a target="_blank" href="https://github.com/azmenak/react-stripe-checkout#requirements" rel="noopener noreferrer">example of usage</a>. The <code>StripeCheckout</code> component <em>requires</em> two props: <code>stripeKey</code> and <code>token</code>. Other props are optional, and you are familiar with all of them except <code>desktopShowModal</code>. This prop controls whether the Stripe modal is open or closed. Read more about <a target="_blank" href="https://github.com/azmenak/react-stripe-checkout/pull/15" rel="noopener noreferrer">desktopShowModal</a>. </p>
<p>Wrap the Material-UI <code>&lt;Button&gt;</code> with <code>&lt;StripeCheckout&gt;</code>:</p>
<pre><code><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StripeCheckout</span>
 <span class="hljs-attr">stripeKey</span>=</span></span><span class="hljs-template-variable">{StripePublishableKey}</span><span class="xml"><span class="hljs-tag">
 <span class="hljs-attr">token</span>=</span></span><span class="hljs-template-variable">{this.onToken}</span><span class="xml"><span class="hljs-tag">
 <span class="hljs-attr">name</span>=</span></span><span class="hljs-template-variable">{book.name}</span><span class="xml"><span class="hljs-tag">
 <span class="hljs-attr">amount</span>=</span></span><span class="hljs-template-variable">{book.price * 100}</span><span class="xml"><span class="hljs-tag">
 <span class="hljs-attr">email</span>=</span></span><span class="hljs-template-variable">{user.email}</span><span class="xml"><span class="hljs-tag">
 <span class="hljs-attr">desktopShowModal</span>=</span></span><span class="hljs-template-variable">{showModal || null}</span><span class="xml"><span class="hljs-tag">
&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"contained"</span> <span class="hljs-attr">style</span>=</span></span><span class="hljs-template-variable">{styleBuyButton}</span><span class="xml"><span class="hljs-tag"> <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span>&gt;</span>
   Buy for $</span><span class="hljs-template-variable">{book.price}</span><span class="xml">
 <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">StripeCheckout</span>&gt;</span></span></code></pre></li>
</ol>
<p>As you can see from above, Stripe requires us to pass a publishable key to our component <em>on the client</em>. To do so, we need to define the global variable <code>StripePublishableKey</code> and make this variable available to our <code>components/customer/BuyButton.js</code> file. The problem is that env variables inside <code>.env</code> are <em>only available on server</em>. </p>
<p>There are multiple ways to make environmental variables universally available.  Universally, in this context, means on both client and server. Next.js provides at least two examples. </p>
<p>The <a target="_blank" href="https://github.com/zeit/next.js/tree/canary/examples/with-universal-configuration" rel="noopener noreferrer">first solution</a> is to use the babel plugin <code>babel-plugin-transform-define</code>. With this plugin, we can create a file that contains universally available variables. This solution requires us to create a configuration file for Babel (<code>.babelrc</code>), so we can extend Babel functionality with the <code>babel-plugin-transform-define</code> plugin. As a team, we strive to keep as few configurations as possible. Otherwise, we may find ourselves in a so-called 'configuration hell'.</p>
<p>The <a target="_blank" href="https://github.com/zeit/next.js/tree/canary/examples/with-universal-configuration-runtime" rel="noopener noreferrer">second solution</a> does not require configuring Babel. Instead, it requires us to pass environmental variables as part of a command, like this:</p>
<pre>StripePublishableKey=pk_test_12345 yarn dev</pre>

<p>We simply prepended <code>StripePublishableKey=pk_test_12345</code> to our <code>yarn dev</code> command. After you run the above command, you are able to access the <code>StripePublishableKey</code> environmental variable in your application as <code>process.env.StripePublishableKey</code>. However, <code>process.env.StripePublishableKey</code> is only accessible on the server, it's not universally accessible.</p>
<p>We can make the <code>StripePublishableKey</code> environmental variable available on the client by adding it to <code>_document.js</code>. When a user loads a page for the first time, our Next.js app renders <code>_document.js</code> on the server and sends it to the client together with any environmental variables.</p>
<p>Open your <code>pages/_document.js</code> file. Under the imports section, add the following code snippet:</p>
<pre><code><span class="hljs-keyword">const</span> { StripePublishableKey } = <span class="hljs-built_in">process</span>.env;
<span class="hljs-comment">// console.log(StripePublishableKey);</span>

<span class="hljs-keyword">const</span> env = { StripePublishableKey };
<span class="hljs-comment">// console.log(env); </span></code></pre><p>The first line simply defines our new variable <code>StripePublishableKey</code>, which points to <code>process.env.StripePublishableKey</code>.<br>The fourth line, creates an <code>env.StripePublishableKey</code> parameter inside the <code>env</code> object. This parameter's value is <code>StripePublishableKey</code> (defined on the first line).</p>
<p>We used ES6 object destructuring for both of the above lines.</p>
<p>We also used object shorthand on the fourth line - we wrote <code>const env = { StripePublishableKey }</code> instead of <code>const env = { StripePublishableKey: StripePublishableKey }</code>.</p>
<p>Start your app with <code>StripePublishableKey=pk_test_12345 yarn dev</code>. Uncomment the <code>console.log()</code> statements and reload the page so your app executes <code>_document.js</code>. Your terminal will print:</p>
<pre><code><span class="hljs-selector-tag">pk_test_12345</span>
{ <span class="hljs-attribute">StripePublishableKey</span>: <span class="hljs-string">'pk_test_12345'</span> }</code></pre><p>This terminal output means that we successfully accessed our <code>StripePublishableKey</code> value using <code>process.env</code> and successfully created an <code>env</code> object that has the <code>env.StripePublishableKey</code> name-value pair.</p>
<p>The next step is to add an <code>env</code> object to the <code>MyDocument</code> component. Find this location in <code>page/_document.js</code>:</p>
<pre><code>
<span class="hljs-section">&lt;Main /&gt;</span>
<span class="hljs-section">&lt;NextScript /&gt;</span>
</code></pre><p>Modify like this:</p>
<pre><code><span class="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">Main</span> /&gt;</span>
</span><span class="hljs-template-tag">{/* <span class="hljs-name">eslint-disable-next-line</span> react/no-danger */}</span><span class="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=</span></span><span class="hljs-template-variable">{{ __html: `__ENV__ = ${htmlescape(env)}</span><span class="xml"><span class="hljs-tag">` }} /&gt;</span><span class="handlebars"><span class="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">NextScript</span> /&gt;</span>
</span></span></span></code></pre><p>The first of these newly added lines simply disables the Eslint warning for <code>dangerouslySetInnerHTML</code>.<br>The second line adds a <code>script</code> tag to the <code>Document</code> component.</p>
<p>Two explanatory notes:</p>
<ul>
<li><p>You may have noticed two underscore symbols on each side of <code>__ENV__</code>. We've added underscores to avoid name collision and to indicate that tge variable is used on the browser. This is a practical convention, <a target="_blank" href="https://stackoverflow.com/questions/6547293/why-some-attribute-names-start-with-double-underscore-in-javascript" rel="noopener noreferrer">read more about it here</a>.</p>
</li>
<li><p>The JavaScript object <code>env</code> can't be rendered as HTML since it's not a string. We need to stringify <code>env</code>. The proper way to stringify it is to use <code>htmlescape()</code> over <code>JSON.stringify()</code> <a target="_blank" href="http://timelessrepo.com/json-isnt-a-javascript-subset" rel="noopener noreferrer">since JSON is not exactly a subset of JavaScript</a>. Some characters inside the string that are accepted by JSON are not accepted by JavaScript.</p>
</li>
</ul>
<p>Go to your browser, open <code>Dev Tools &gt; Elements</code>, and find our newly added <code>script</code> tag:<br><img src="https://user-images.githubusercontent.com/10218864/39905261-445fc1fc-5491-11e8-8169-8c7cd9262dd9.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>On the client (browser console), we have an <code>__ENV__</code> object with the expected value for <code>StripePublishableKey</code>.</p>
<p>In Next.js, the initial load is server-side rendered and subsequent loads are client-side rendered. Thus we need to write conditional code to account for this conditional behavior.</p>
<p>Create a <code>lib/env.js</code> file that contains only a single line of code:</p>
<pre>export default (typeof window !== 'undefined' ? window.__ENV__ : process.env);</pre>

<p>If a <code>window</code> objects exists (<code>typeof window !== 'undefined'</code>), then this file exports <code>window.__ENV__</code>, which is <code>{"StripePublishableKey":"pk_test_12345"}</code>. That's because in our browser window, we have a <code>script</code> tag with content <code>__ENV__ = {"StripePublishableKey":"pk_test_12345"}</code>.</p>
<p><em>Else</em>, when a <code>window</code> object does not exist (server environment), the file exports the server-side environment, which is <code>process.env</code>.</p>
<p>That's pretty much it! We've covered both cases for page rendering: server-side and client-side.</p>
<p>Open your <code>components/customer/BuyButton.js</code> file. Import <code>env</code> from <code>lib/env.js</code>:</p>
<pre>import env from '../../lib/env';</pre>

<p>Then access <code>StripePublishableKey</code> like this:</p>
<pre>const { StripePublishableKey } = env;</pre>


<p>From now on, when you run your app locally, remember to start your app with:</p>
<pre>StripePublishableKey=pk_test_xxxxxx yarn dev</pre>

<p>Replace <code>pk_test_xxxxxx</code> with your actual value for the <em>test</em> publishable key from Stripe.</p>
<p>Plug the code from steps 1-7 into our <code>BuyButton</code> component carcass that we outlined in the beginning of this section:</p>
<pre><code><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>;
<span class="hljs-keyword">import</span> StripeCheckout <span class="hljs-keyword">from</span> <span class="hljs-string">'react-stripe-checkout'</span>;
<span class="hljs-keyword">import</span> NProgress <span class="hljs-keyword">from</span> <span class="hljs-string">'nprogress'</span>;
<span class="hljs-keyword">import</span> Button <span class="hljs-keyword">from</span> <span class="hljs-string">'@material-ui/core/Button'</span>;

<span class="hljs-keyword">import</span> { buyBook } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/api/customer'</span>;
<span class="hljs-keyword">import</span> notify <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/notifier'</span>;

<span class="hljs-keyword">import</span> env <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/env'</span>;

<span class="hljs-keyword">const</span> { StripePublishableKey } = env;

<span class="hljs-keyword">const</span> styleBuyButton = {
  <span class="hljs-attr">margin</span>: <span class="hljs-string">'20px 20px 20px 0px'</span>,
  <span class="hljs-attr">font</span>: <span class="hljs-string">'14px Muli'</span>,
};

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BuyButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  <span class="hljs-keyword">static</span> propTypes = {
    <span class="hljs-attr">book</span>: PropTypes.shape({
      <span class="hljs-attr">_id</span>: PropTypes.string.isRequired,
    }),
    <span class="hljs-attr">user</span>: PropTypes.shape({
      <span class="hljs-attr">_id</span>: PropTypes.string.isRequired,
    }),
    <span class="hljs-attr">showModal</span>: PropTypes.bool,
  };

  <span class="hljs-keyword">static</span> defaultProps = {
    <span class="hljs-attr">book</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">showModal</span>: <span class="hljs-literal">false</span>,
  };

  <span class="hljs-keyword">constructor</span>(props) {
    <span class="hljs-keyword">super</span>(props);

    <span class="hljs-keyword">this</span>.state = {
      <span class="hljs-attr">showModal</span>: !!props.showModal,
    };
  }

  onToken = <span class="hljs-keyword">async</span> (token) =&gt; {
    NProgress.start();
    <span class="hljs-keyword">const</span> { book } = <span class="hljs-keyword">this</span>.props;
    <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">showModal</span>: <span class="hljs-literal">false</span> });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> buyBook({ <span class="hljs-attr">stripeToken</span>: token, <span class="hljs-attr">id</span>: book._id });
      notify(<span class="hljs-string">'Success!'</span>);
      NProgress.done();
    } <span class="hljs-keyword">catch</span> (err) {
      NProgress.done();
      notify(err);
    }
  };

  onLoginClicked = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> { user } = <span class="hljs-keyword">this</span>.props;

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/auth/google'</span>;
    }
  };

  render() {
    <span class="hljs-keyword">const</span> { book, user } = <span class="hljs-keyword">this</span>.props;
    <span class="hljs-keyword">const</span> { showModal } = <span class="hljs-keyword">this</span>.state;

    <span class="hljs-keyword">if</span> (!book) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">variant</span>=<span class="hljs-string">"contained"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{styleBuyButton}</span>
            <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.onLoginClicked}</span>
          &gt;</span>
            Buy for ${book.price}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    }

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StripeCheckout</span>
        <span class="hljs-attr">stripeKey</span>=<span class="hljs-string">{StripePublishableKey}</span>
        <span class="hljs-attr">token</span>=<span class="hljs-string">{this.onToken}</span>
        <span class="hljs-attr">name</span>=<span class="hljs-string">{book.name}</span>
        <span class="hljs-attr">amount</span>=<span class="hljs-string">{book.price</span> * <span class="hljs-attr">100</span>}
        <span class="hljs-attr">email</span>=<span class="hljs-string">{user.email}</span>
        <span class="hljs-attr">desktopShowModal</span>=<span class="hljs-string">{showModal</span> || <span class="hljs-attr">null</span>}
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"contained"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styleBuyButton}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"primary"</span>&gt;</span>
          Buy for ${book.price}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">StripeCheckout</span>&gt;</span></span>
    );
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> BuyButton;</code></pre><p>Above, we wrote the basic version of our <code>BuyButton</code> component. As we progress in this chapter, we will improve the UX of our checkout flow and make necessary changes to this component. We will make these improvements in the section called <code>Checkout flow</code>.</p>
<p>We will test out our <code>BuyButton</code> component at the end of the next section, after adding it to our <code>ReadChapter</code> page.</p>
<p>As you've probably noticed from the code above - after a user submits card details, we call the <code>onToken</code> function that calls a <code>buyBook()</code> API method. In the next section, we discuss this API method and its corresponding Express route and static method for the Book model. We also discuss Stripe API and create a new Purchase model.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="buy-book-logic" href="#buy-book-logic" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="buy-book-logic">
          Buy book logic
        </span>
      </h2><p>In this section, we will discuss the <code>buyBook()</code> API method, Express route <code>/buy-book</code>, and static method <code>buy()</code> for our Book model. As you learned in Chapters 5 and 6:</p>
<ul>
<li>a page or component calls an API method</li>
<li>the API method sends a request to an Express route</li>
<li>that Express route calls and waits for a static method</li>
<li>the static method fetches or updates data using Mongoose methods (aka Mongoose Queries)</li>
</ul>
<h4 style="color: #FFF;">
        <a name="api-method-buybook-" href="#api-method-buybook-" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        API method buyBook()
      </h4><p>Let's decide which type of method to use for a request sent by our <code>buyBook</code> API method. Since we send <code>book._id</code> (as <code>id</code>) and <code>token</code> (as <code>stripeToken</code>) to the <em>server</em>, the method should be POST. Because the method is POST, you don't need to specify it explicitly, as POST is a default method (check out <code>lib/api/sendRequest.js</code>, which we wrote <a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#api-methods" rel="noopener noreferrer">in Chapter 5</a>).</p>
<p>Next, let's decide the route to use for the API endpoint; for example, let it be <code>/buy-book</code>.</p>
<p>If you don't remember how we wrote API methods, check out <code>lib/api/admin.js</code> and <a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#internal-apis" rel="noopener noreferrer">Chapter 5, Section Internal APIs</a>. For example, to display a list of books on our Admin dashboard:<br><code>lib/api/admin.js</code> :</p>
<pre><code><span class="hljs-keyword">import</span> sendRequest <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendRequest'</span>;

<span class="hljs-keyword">const</span> BASE_PATH = <span class="hljs-string">'/api/v1/admin'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getBookList = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
  sendRequest(<span class="hljs-string">`<span class="hljs-subst">${BASE_PATH}</span>/books`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  });</code></pre><p>Create a <code>lib/api/customer.js</code> file with the <code>buyBook</code> API method:<br><code>lib/api/customer.js</code> :</p>
<pre><code><span class="hljs-keyword">import</span> sendRequest <span class="hljs-keyword">from</span> <span class="hljs-string">'./sendRequest'</span>;

<span class="hljs-keyword">const</span> BASE_PATH = <span class="hljs-string">'/api/v1/customer'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> buyBook = <span class="hljs-function">(<span class="hljs-params">{ id, stripeToken }</span>) =&gt;</span>
  sendRequest(<span class="hljs-string">`<span class="hljs-subst">${BASE_PATH}</span>/buy-book`</span>, {
    <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify({ id, stripeToken }),
  });</code></pre><p>Notice that we pass stringified <code>id</code> and <code>stripeToken</code> values to the request body. We will get these values from the request body when we write our Express route.</p>
<h4 style="color: #FFF;">
        <a name="express-route-39-buy-book-39-" href="#express-route-39-buy-book-39-" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Express route '/buy-book'
      </h4><p>First things first, we need to make sure that Customer-related API endpoints are indeed defined on the server. Open your <code>server/api/index.js</code> file and find the line <code>server.use('/api/v1/customer', customerApi);</code>:<br><code>server/api/index.js</code> :</p>
<pre><code><span class="hljs-keyword">const</span> publicApi = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./public'</span>);
<span class="hljs-keyword">const</span> customerApi = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./customer'</span>);
<span class="hljs-keyword">const</span> adminApi = <span class="hljs-keyword">require</span>(<span class="hljs-string">'./admin'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">api</span><span class="hljs-params">(server)</span> </span>{
  server.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/api/v1/public'</span>, publicApi);
  server.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/api/v1/customer'</span>, customerApi);
  server.<span class="hljs-keyword">use</span>(<span class="hljs-string">'/api/v1/admin'</span>, adminApi);
}

module.exports = api;</code></pre><p>To remember how you wrote these Express routes, open up <code>server/api/admin.js</code>. Here is one Express route that calls and waits for the static method <code>Book.list()</code>:<br><code>server/api/admin.js</code> :</p>
<pre><code><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> Book = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/Book'</span>);
<span class="hljs-keyword">const</span> User = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/User'</span>);
<span class="hljs-keyword">const</span> { getRepos } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../github'</span>);
<span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../logs'</span>);

<span class="hljs-keyword">const</span> router = express.Router();

router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!req.user || !req.user.isAdmin) {
    res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Unauthorized'</span> });
    <span class="hljs-keyword">return</span>;
  }

  next();
});

router.get(<span class="hljs-string">'/books'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> books = <span class="hljs-keyword">await</span> Book.list();
    res.json(books);
  } <span class="hljs-keyword">catch</span> (err) {
    res.json({ <span class="hljs-attr">error</span>: err.message || err.toString() });
  }
});

<span class="hljs-built_in">module</span>.exports = router;</code></pre><p>To write an Express route for our <code>buyBook</code> API method, keep in mind a few differences:</p>
<ul>
<li><p>inside the Express middleware that checks for user permissions, we don't need to check for <code>!req.user.isAdmin</code></p>
</li>
<li><p>the route is <code>/buy-book</code></p>
</li>
<li><p>the method is <code>POST</code>; thus, use <code>router.post()</code> instead of <code>router.get()</code></p>
</li>
<li><p>call <code>Book.buy()</code> instead of <code>Book.list()</code></p>
</li>
<li><p>pass three parameters to the <code>buy()</code> static method: book id as <code>id</code>, Stripe token as <code>stripeToken</code>, and <code>user</code></p>
<p>We get the first two parameters from the request body <code>req.body</code> using ES6 object destructuring:</p>
<pre>const { id, stripeToken } = req.body;</pre>

<p>The third parameter is from <code>req.user</code> that we discussed in detail <a target="_blank" href="https://builderbook.org/books/builder-book/authentication-hoc-promise-async-await-static-method-for-user-model-google-oauth#google-oauth-auth-function" rel="noopener noreferrer">in Chapter 3</a>.</p>
</li>
</ul>
<p>Go to your <code>server/api/customer.js</code> file.<br>Take into account these specifics above and put together the Express middleware and Express route:<br><code>server/api/customer.js</code> :</p>
<pre><code><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> Book = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../models/Book'</span>);
<span class="hljs-keyword">const</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../logs'</span>);

<span class="hljs-keyword">const</span> router = express.Router();

router.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!req.user) {
    res.status(<span class="hljs-number">401</span>).json({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Unauthorized'</span> });
    <span class="hljs-keyword">return</span>;
  }

  next();
});

router.post(<span class="hljs-string">'/buy-book'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { id, stripeToken } = req.body;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> Book.buy({ id, stripeToken, <span class="hljs-attr">user</span>: req.user });
    res.json({ <span class="hljs-attr">done</span>: <span class="hljs-number">1</span> });
  } <span class="hljs-keyword">catch</span> (err) {
    logger.error(err);
    res.json({ <span class="hljs-attr">error</span>: err.message || err.toString() });
  }
});

<span class="hljs-built_in">module</span>.exports = router;</code></pre><p>In a typical Express route with the <code>GET</code> method, we would send a response that contains some data from our database (for example, a <code>book</code> or <code>chapter</code> object). However, in a typical Express route with the <code>POST</code> method, we can simply respond with the object <code>done: 1</code> or <code>save: 1</code> or <code>success: 1</code>.</p>
<h4 style="color: #FFF;">
        <a name="static-method-book-buy-" href="#static-method-book-buy-" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Static method Book.buy()
      </h4><p>With the API method and Express route out of way, let's discuss the static method <code>buy()</code> in our Book model. This static method will do multiple things:</p>
<ol>
<li>use Mongoose's <code>findById()</code> to find a book</li>
<li>check if a user already bought a book by searching (and waiting) for a <code>Purchase</code> document with <code>userId</code> and <code>bookId</code></li>
<li>if a user did not buy a book, call and wait for a <code>stripeCharge()</code> method defined at <code>server/stripe.js</code> (discussed later in this section)</li>
<li>send an email to a user (same way we sent a welcome email in <a target="_blank" href="https://builderbook.org/books/builder-book/testing-with-jest-debugging-with-winston-transactional-emails-in-app-notifications#transactional-emails-with-aws-ses" rel="noopener noreferrer">Chapter 4</a>)</li>
<li>finally, create a new <code>Purchase</code> document with all necessary parameters</li>
</ol>
<p>High-level structure of our <code>buy</code> static method that takes the three arguments discussed earlier:<br><code>server/models/Book.js</code> :</p>
<pre><code><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> buy({ id, user, stripeToken }) {
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'User required'</span>);
  }

  <span class="hljs-comment">// 1. find book by id</span>

  <span class="hljs-keyword">if</span> (!book) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Book not found'</span>);
  }

  <span class="hljs-comment">// 2. check if user bought book already</span>

  <span class="hljs-comment">// 3. call stripeCharge() method</span>

  <span class="hljs-comment">// 4. send transactional email confirming purchase</span>

  <span class="hljs-comment">// 5. create new Purchase document</span>
}</code></pre><p>The only two snippets of code that we did not mention are those that throw errors in case <code>user</code> and <code>book</code> objects do not exist.</p>
<p>Let's discuss each step in detail:</p>
<ol>
<li><p>Open <code>server/models/Book.js</code> and find the static method <code>syncContent()</code> that finds a book by id using the Mongoose method <code>findById()</code>:</p>
<pre>const book = await this.findById(id, 'userId githubRepo githubLastCommitSha');</pre>

<p>In our case, instead of returning <code>userId githubRepo githubLastCommitSha</code> parameters, we want to return <code>name slug price</code>. Thus, the code for step 1 is simply:</p>
<pre>const book = await this.findById(id, 'name slug price');</pre>
</li>
<li><p>At this point in the code, we have both <code>user</code> and <code>book</code> objects. Here we use <code>user._id</code> from <code>user</code> and <code>id</code> from <code>book</code> to check if a <code>Purchase</code> document exists on our database. If a user bought a book already, we create a <code>Purchase</code> document in the <code>Purchase</code> collection of our database. It's important to check if this <code>Purchase</code> document exists, so a user does not buy a book twice. This is an unlikely edge case, but let's take care of it.</p>
<p>Define the boolean parameter <code>isPurchased</code>, which is true if the count of found documents is greater than zero:</p>
<pre>const isPurchased = (await Purchase.find({ userId: user._id, bookId: id }).countDocuments()) &gt; 0;</pre>

<p>If <code>isPurchased</code> is true, then we throw an error. Our code for step 2 is:</p>
<pre><code>const isPurchased = (await <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Purchase</span>.</span></span>find({ userId: user._id, bookId: id }).count<span class="hljs-constructor">Documents()</span>) &gt; <span class="hljs-number">0</span>;
<span class="hljs-keyword">if</span> (isPurchased) {
 throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">Error('Already <span class="hljs-params">bought</span> <span class="hljs-params">this</span> <span class="hljs-params">book</span>')</span>;
}</code></pre></li>
<li><p>In this step, we pass three parameters to the <code>stripeCharge()</code> method. Parameters: <code>book.price</code> from <code>book</code> as <code>amount</code>, <code>stripeToken.id</code> from <code>stripeToken</code> (we passed this to the server from client via our <code>buyBook</code> API method) as <code>token</code>, <code>user.email</code> from <code>user</code> as <code>buyerEmail</code> (we define this method in the next subsection). Code for step 3:</p>
<pre><code><span class="hljs-attr">const</span> <span class="hljs-string">chargeObj = await stripeCharge({</span>
 <span class="hljs-attr">amount</span>: <span class="hljs-string">book.price * 100,</span>
 <span class="hljs-attr">token</span>: <span class="hljs-string">stripeToken.id,</span>
 <span class="hljs-attr">buyerEmail</span>: <span class="hljs-string">user.email,</span>
<span class="hljs-attr">});</span></code></pre><p>For bookkeeping, we will save <code>chargeObj</code> as a parameter in the <code>Purchase</code> document in step 5.</p>
</li>
<li><p>Remember how we send the transactional welcome email to new users - open <code>server/models/User.js</code> and find the static method <code>signInOrSignUp()</code> inside it:</p>
<pre><code><span class="hljs-keyword">const</span> template = <span class="hljs-keyword">await</span> getEmailTemplate(<span class="hljs-string">'welcome'</span>, {
 userName: displayName,
});

<span class="hljs-keyword">try</span> {
 <span class="hljs-keyword">await</span> sendEmail({
   <span class="hljs-keyword">from</span>: <span class="hljs-string">`Kelly from Builder Book &lt;<span class="hljs-subst">${process.env.EMAIL_SUPPORT_FROM_ADDRESS}</span>&gt;`</span>,
   to: [email],
   subject: template.subject,
   body: template.message,
 });
} <span class="hljs-keyword">catch</span> (err) {
 logger.error(<span class="hljs-string">'Email sending error:'</span>, err);
}</code></pre><p>The code for sending an email after a user bought a book will be very similar. Here are small differences to keep in mind:</p>
<ul>
<li>First, in addition to passing the <code>userName</code> parameter to <code>getEmailTemplate()</code>, we will pass <code>bookTitle</code> and <code>bookUrl</code>.</li>
<li>Second, the template name is <code>purchase</code> instead of <code>welcome</code> (we don't want to send the welcome email again).</li>
<li>Third, since we are not inside the User model but Book model, the value of <code>to</code> inside the <code>sendEmail()</code> method is <code>[user.email]</code> instead of <code>[email]</code>.</li>
</ul>
<p>With these change in mind, you will get the following code for step 4:</p>
<pre><code><span class="hljs-keyword">const</span> template = <span class="hljs-keyword">await</span> getEmailTemplate(<span class="hljs-string">'purchase'</span>, {
 userName: user.displayName,
 bookTitle: book.name,
 bookUrl: <span class="hljs-string">`<span class="hljs-subst">${ROOT_URL}</span>/books/<span class="hljs-subst">${book.slug}</span>/introduction`</span>,
});

<span class="hljs-keyword">try</span> {
 <span class="hljs-keyword">await</span> sendEmail({
   <span class="hljs-keyword">from</span>: <span class="hljs-string">`Kelly from builderbook.org &lt;<span class="hljs-subst">${process.env.EMAIL_SUPPORT_FROM_ADDRESS}</span>&gt;`</span>,
   to: [user.email],
   subject: template.subject,
   body: template.message,
 });
} <span class="hljs-keyword">catch</span> (error) {
 logger.error(<span class="hljs-string">'Email sending error:'</span>, error);
}</code></pre><p>Since we used <code>ROOT_URL</code>, we have to define it within a scope of <code>server/models/Book.js</code>. Add following line of code right after section with imports:<br><code>const ROOT_URL = '<a target="_blank" href="http://localhost:8000'" rel="noopener noreferrer">http://localhost:8000'</a>;</code></p>
<p>We don't have an EmailTemplate with the name <code>purchase</code>. Open <code>server/models/EmailTemplate.js</code> and add a <code>purchase</code> template right after the <code>welcome</code> template:</p>
<pre><code><span class="xml">{
 name: 'purchase',
 subject: 'You purchased book at builderbook.org',
 message: `<span class="hljs-tag">&lt;<span class="hljs-name">%=</span> <span class="hljs-attr">userName</span> %&gt;</span>,
   <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
     Thank you for purchasing our book! You will get confirmation email from Stripe shortly.
   <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
     Start reading your book: <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"</span></span></span><span class="hljs-template-variable">{{bookUrl}}</span><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span></span><span class="hljs-template-variable">{{bookTitle}}</span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
     If you have any questions while reading the book, 
     please fill out an issue on 
     <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://github.com/builderbook/builderbook/issues"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"blank"</span>&gt;</span>Github<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>.
   <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

   Kelly &amp; Timur, Team Builder Book
 `,
},</span></code></pre><p>Done. The next time you start your app, a new EmailTemplate document with <code>"name": "purchase"</code> will be created on MongoDB.</p>
</li>
<li><p>This one is straightforward. To create a new <code>Purchase</code> document, we use the Mongoose method <code>create()</code> on our Purchase model. Besides adding a <code>createdAt</code> timestamp, we pass the following parameters to the document: <code>user._id</code>, <code>book._id</code>, <code>book.price</code>, and <code>chargeObject</code> as <code>userId</code>, <code>bookId</code>, <code>amount</code>, and <code>stripeCharge</code>, respectively:</p>
<pre><code><span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Purchase</span><span class="hljs-selector-class">.create</span>({
 <span class="hljs-attribute">userId</span>: user._id,
 bookId: book._id,
 amount: book.price * <span class="hljs-number">100</span>,
 stripeCharge: chargeObj,
 createdAt: new <span class="hljs-built_in">Date</span>(),
});</code></pre></li>
</ol>
<p>Plug in the code from steps 1 to 5 into our high-level structure of the <code>buy</code> static method. Add this method within <code>BookClass</code> of our Book model at <code>server/models/Book.js</code>:</p>
<pre><code><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> buy({ id, user, stripeToken }) {
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'User required'</span>);
  }

  <span class="hljs-keyword">const</span> book = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.findById(id, <span class="hljs-string">'name slug price'</span>);
  <span class="hljs-keyword">if</span> (!book) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Book not found'</span>);
  }

  <span class="hljs-keyword">const</span> isPurchased = (<span class="hljs-keyword">await</span> Purchase.find({ userId: user._id, bookId: id }).countDocuments()) &gt; <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (isPurchased) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Already bought this book'</span>);
  }

  <span class="hljs-keyword">const</span> chargeObj = <span class="hljs-keyword">await</span> stripeCharge({
    amount: book.price * <span class="hljs-number">100</span>,
    token: stripeToken.id,
    buyerEmail: user.email,
  });

  <span class="hljs-keyword">const</span> template = <span class="hljs-keyword">await</span> getEmailTemplate(<span class="hljs-string">'purchase'</span>, {
    userName: user.displayName,
    bookTitle: book.name,
    bookUrl: <span class="hljs-string">`<span class="hljs-subst">${ROOT_URL}</span>/books/<span class="hljs-subst">${book.slug}</span>/introduction`</span>,
  });

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> sendEmail({
      <span class="hljs-keyword">from</span>: <span class="hljs-string">`Kelly from builderbook.org &lt;<span class="hljs-subst">${process.env.EMAIL_SUPPORT_FROM_ADDRESS}</span>&gt;`</span>,
      to: [user.email],
      subject: template.subject,
      body: template.message,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    logger.error(<span class="hljs-string">'Email sending error:'</span>, error);
  }

  <span class="hljs-keyword">return</span> Purchase.create({
    userId: user._id,
    bookId: book._id,
    amount: book.price * <span class="hljs-number">100</span>,
    stripeCharge: chargeObj,
    createdAt: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(),
  });
}</code></pre><p>This is pretty much the final version of our <code>buy()</code> static method. We will make only one upgrade - later in this chapter, we will call the <code>subscribe()</code> method to add a user's email to a Mailchimp list.</p>
<p>Remember to add all missing imports to <code>server/models/Book.js</code>:</p>
<pre><code><span class="hljs-keyword">const</span> Purchase = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Purchase'</span>);
<span class="hljs-keyword">const</span> getEmailTemplate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./EmailTemplate'</span>);
<span class="hljs-keyword">const</span> { stripeCharge } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../stripe'</span>);
<span class="hljs-keyword">const</span> sendEmail = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../aws'</span>);</code></pre><p>In the next two subsections, we will discuss <code>stripeCharge()</code> and Purchase model. We imported and used them inside <code>Book.buy()</code>, but we have not defined them.</p>
<h4 style="color: #FFF;">
        <a name="stripecharge-method" href="#stripecharge-method" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        stripeCharge() method
      </h4><p>To create a charge with Stripe, we use the <a target="_blank" href="https://github.com/stripe/stripe-node" rel="noopener noreferrer">stripe</a> package and follow this <a target="_blank" href="https://github.com/stripe/stripe-node#usage" rel="noopener noreferrer">official example</a>:</p>
<pre><code><span class="hljs-attribute">var stripe</span> = require(<span class="hljs-string">'stripe'</span>)(<span class="hljs-string">'sk_test_...'</span>);

<span class="hljs-attribute">var customer</span> = await stripe.customers.create(
  { email: <span class="hljs-string">'customer@example.com'</span> }
);</code></pre><p>There is no strong reason for us to create <code>customer</code> as shown in the official example, since buying a digital book is a one-time transaction. Instead of creating <code>customer</code>, we want to create <code>charge</code>, so the code will be <code>stripe.charges.create()</code> instead of <code>stripe.customers.create</code>.</p>
<p>Let's define <code>API_KEY</code> for development and production environments:</p>
<pre><code><span class="hljs-keyword">const</span> dev = <span class="hljs-built_in">process</span>.env.NODE_ENV !== <span class="hljs-string">'production'</span>;
<span class="hljs-keyword">const</span> API_KEY = dev ? <span class="hljs-built_in">process</span>.env.Stripe_Test_SecretKey : <span class="hljs-built_in">process</span>.env.Stripe_Live_SecretKey;</code></pre><p>Next, define the constant <code>client</code> as well as <code>stripe</code> with the passed <code>API_KEY</code>:</p>
<pre>const client = stripe(API_KEY);</pre>

<p>We will specify only five parameters out of two dozen possible parameters for <code>stripeCharge()</code> (to see all parameters, check <a target="_blank" href="https://stripe.com/docs/api/node#charges" rel="noopener noreferrer">Charge, Stripe API</a>). In addition to the three parameters that we passed to <code>stripeCharge()</code> inside our <code>Book.buy()</code> static method, we will add two more:</p>
<pre><code>currency: <span class="hljs-symbol">'usd</span>',
description: <span class="hljs-symbol">'Payment</span> <span class="hljs-keyword">for</span> the book <span class="hljs-keyword">at</span> builderbook.org',</code></pre><p>For charge creation, you get:</p>
<pre><code><span class="hljs-keyword">return</span> client.charges.create({
  amount,
  source: token,
  receipt_email: buyerEmail,
  currency: <span class="hljs-symbol">'usd</span>',
  description: <span class="hljs-symbol">'Payment</span> <span class="hljs-keyword">for</span> the book <span class="hljs-keyword">at</span> builderbook.org',
});</code></pre><p>Create a <code>server/stripe.js</code> file. Add definitions of <code>API_KEY</code>, <code>client</code> and above snippet that creates charge:<br><code>server/stripe.js</code>:</p>
<pre><code><span class="hljs-keyword">const</span> stripe = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stripe'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stripeCharge</span>(<span class="hljs-params">{
  amount, token, buyerEmail,
}</span>) </span>{
  <span class="hljs-keyword">const</span> dev = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;
  <span class="hljs-keyword">const</span> API_KEY = dev ? process.env.Stripe_Test_SecretKey : process.env.Stripe_Live_SecretKey;
  <span class="hljs-keyword">const</span> client = stripe(API_KEY);

  <span class="hljs-keyword">return</span> client.charges.create({
    amount,
    <span class="hljs-attr">source</span>: token,
    <span class="hljs-attr">receipt_email</span>: buyerEmail,
    <span class="hljs-attr">currency</span>: <span class="hljs-string">'usd'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Payment for the book at builderbook.org'</span>,
  });
}

exports.stripeCharge = stripeCharge;</code></pre><p>Remember to get <code>Stripe_Test_SecretKey</code> and <code>Stripe_Live_SecretKey</code> values from your Stripe account and add them to the <code>.env</code> file.</p>
<p>You will need to add a total of 4 Stripe keys to <code>.env</code> file, 2 publishable and 2 secret. After you create Stripe account, find keys at <a target="_blank" href="https://dashboard.stripe.com/account/apikeys" rel="noopener noreferrer">https://dashboard.stripe.com/account/apikeys</a>.</p>
<h4 style="color: #FFF;">
        <a name="purchase-model" href="#purchase-model" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Purchase model
      </h4><p>Our Purchase model is straighforward to write. There are no static methods to define. We want to ensure the uniqueness of our index with:</p>
<pre>mongoSchema.index({ bookId: 1, userId: 1 }, { unique: true });</pre>

<p>We discussed MongoDB indices in detail in <a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#index-in-mongodb" rel="noopener noreferrer">Chapter 5, section Chapter model</a>.</p>
<p>Check out User, Book, Chapter, and EmailTemplate models to remember how to create a model and specify Schema:</p>
<pre>const Purchase = mongoose.model('Purchase', mongoSchema);</pre>

<p>We create a Purchase document inside the <code>Book.buy()</code> static method with:</p>
<pre><code><span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Purchase</span><span class="hljs-selector-class">.create</span>({
  <span class="hljs-attribute">userId</span>: user._id,
  bookId: book._id,
  amount: book.price * <span class="hljs-number">100</span>,
  stripeCharge: chargeObj,
  createdAt: new <span class="hljs-built_in">Date</span>(),
});</code></pre><p>Based on the information above, define Schema:</p>
<pre><code><span class="hljs-string">const</span> <span class="hljs-string">{</span> <span class="hljs-string">Schema</span> <span class="hljs-string">}</span> <span class="hljs-string">=</span> <span class="hljs-string">mongoose;</span>

<span class="hljs-string">const</span> <span class="hljs-string">mongoSchema</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Schema({</span>
<span class="hljs-attr">  userId:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Schema.Types.ObjectId,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  bookId:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Schema.Types.ObjectId,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  amount:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Number,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  stripeCharge:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    id:</span> <span class="hljs-string">String,</span>
<span class="hljs-attr">    amount:</span> <span class="hljs-string">Number,</span>
<span class="hljs-attr">    created:</span> <span class="hljs-string">Number,</span>
<span class="hljs-attr">    livemode:</span> <span class="hljs-string">Boolean,</span>
<span class="hljs-attr">    paid:</span> <span class="hljs-string">Boolean,</span>
<span class="hljs-attr">    status:</span> <span class="hljs-string">String,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  createdAt:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Date,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-string">});</span></code></pre><p>Create a <code>server/models/Purchase.js</code> file and add the following code:<br><code>server/models/Purchase.js</code> :</p>
<pre><code><span class="hljs-string">const</span> <span class="hljs-string">mongoose</span> <span class="hljs-string">=</span> <span class="hljs-string">require('mongoose');</span>

<span class="hljs-string">const</span> <span class="hljs-string">{</span> <span class="hljs-string">Schema</span> <span class="hljs-string">}</span> <span class="hljs-string">=</span> <span class="hljs-string">mongoose;</span>

<span class="hljs-string">const</span> <span class="hljs-string">mongoSchema</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Schema({</span>
<span class="hljs-attr">  userId:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Schema.Types.ObjectId,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  bookId:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Schema.Types.ObjectId,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  amount:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Number,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  stripeCharge:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    id:</span> <span class="hljs-string">String,</span>
<span class="hljs-attr">    amount:</span> <span class="hljs-string">Number,</span>
<span class="hljs-attr">    created:</span> <span class="hljs-string">Number,</span>
<span class="hljs-attr">    livemode:</span> <span class="hljs-string">Boolean,</span>
<span class="hljs-attr">    paid:</span> <span class="hljs-string">Boolean,</span>
<span class="hljs-attr">    status:</span> <span class="hljs-string">String,</span>
  <span class="hljs-string">},</span>
<span class="hljs-attr">  createdAt:</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span> <span class="hljs-string">Date,</span>
<span class="hljs-attr">    required:</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span>
<span class="hljs-string">});</span>

<span class="hljs-string">mongoSchema.index({</span> <span class="hljs-attr">bookId:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">userId:</span> <span class="hljs-number">1</span> <span class="hljs-string">},</span> <span class="hljs-string">{</span> <span class="hljs-attr">unique:</span> <span class="hljs-literal">true</span> <span class="hljs-string">});</span>

<span class="hljs-string">const</span> <span class="hljs-string">Purchase</span> <span class="hljs-string">=</span> <span class="hljs-string">mongoose.model('Purchase',</span> <span class="hljs-string">mongoSchema);</span>

<span class="hljs-string">module.exports</span> <span class="hljs-string">=</span> <span class="hljs-string">Purchase;</span></code></pre><p>In the next section <code>ReadChapter page</code>, we will add our <code>BuyButton</code> component to the <code>ReadChapter</code> page and make a few UX improvements to our checkout flow.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="readchapter-page" href="#readchapter-page" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="readchapter-page">
          ReadChapter page
        </span>
      </h2><p>In this section, we will make necessary changes to our <code>ReadChapter</code> page so that a logged-out user can see <em>preview</em> content and then buy the <em>full</em> content of a book. Two main goals for this section are:</p>
<ul>
<li>conditionally show <code>chapter.htmlExcerpt</code> (preview content) and <code>chapter.htmlContent</code> (full content)</li>
<li>add the <code>BuyButton</code> component and pass props to it</li>
</ul>
<h4 style="color: #FFF;">
        <a name="excerpt-and-full-content" href="#excerpt-and-full-content" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Excerpt and full content
      </h4><p>In this subsection, we modify the <code>ReadChapter</code> page so it shows either <code>chapter.htmlExcerpt</code> or <code>chapter.htmlContent</code> depending on whether a user bought a book or not.</p>
<p>Open <code>pages/public/read-chapter.js</code> and find instances of <code>htmlContent</code>. <a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#readchapter-page" rel="noopener noreferrer">In Chapter 5</a>, we simply defined <code>htmlContent</code> as:</p>
<pre><code><span class="hljs-attribute">let</span> htmlContent = <span class="hljs-string">''</span>;
<span class="hljs-attribute">if</span> (chapter) {
  <span class="hljs-attribute">htmlContent</span> = chapter.htmlContent;
}</code></pre><p>With this definition, the content you write inside a <code>.md</code> file of a Github repo will be displayed on the webpage, unpaywalled. This is fine for writing a free book or documentation. However, we would like our app to support both free and paid content. Thus, we introduce the <code>isFree</code> parameter for chapters.</p>
<p>In Chapter 6, you forked our <a target="_blank" href="https://github.com/builderbook/demo-book" rel="noopener noreferrer">demo-book repo</a>. Navigate to the <code>chapter-1.md</code> file and click the Edit icon. Here is a <a target="_blank" href="https://github.com/builderbook/demo-book/edit/master/chapter-1.md" rel="noopener noreferrer">link</a> to the original file, and here is snapshot of the page:<br><img src="https://user-images.githubusercontent.com/10218864/36941706-6871066a-1f16-11e8-87e8-d4171f0243e2.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>If you add <code>isFree: true</code> to the metadata section of the <code>chapter-1.md</code> file, then the Chapter document created from this file will get a <code>"isFree": true</code> parameter after an Admin user clicks the <code>Sync with Github</code> button. We introduced the code responsible for saving parameters from metadata to a Chapter document <a target="_blank" href="https://builderbook.org/books/builder-book/github-integration-admin-dashboard-testing-admin-ux-and-github-integration#synccontent-for-chapter-model" rel="noopener noreferrer">in Chapter 6</a>.</p>
<p>To make sure that this code works, navigate to the <code>introduction.md</code> file of your forked <code>demo-book</code> repository and click the Edit icon. You will see <code>isFree: true</code> inside the metadata section:<br><img src="https://user-images.githubusercontent.com/10218864/36941749-a2733490-1f17-11e8-9b1c-7d523a31e6d8.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Now go to Atlas, go to the <code>test.chapters</code> collection, and find the chapter document created from the <code>introduction.md</code> file. You will indeed see the proper <code>isFree</code> parameter:<br><img src="https://user-images.githubusercontent.com/10218864/54499883-10955700-48d4-11e9-961f-b3b8796a2f14.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Alright, now we have a useful boolean parameter, <code>chapter.isFree</code>, that we can use to control whether we show <code>chapter.htmlExcerpt</code> or <code>chapter.htmlContent</code>. When <code>chapter.isFree</code> is true, the page should display <code>chapter.htmlContent</code>. When false, <code>chapter.htmlExcerpt</code>.</p>
<p>The next step is to introduce another boolean parameter: <code>chapter.isPurchased</code>. This will allow users who purchased a book to see its content. When the <code>chapter.isPurchased</code> parameter is true, the page should display <code>chapter.htmlContent</code>, even when <code>chapter.isFree</code> is false. To set <code>isPurchased</code> on the <code>chapter</code> object, we have to modify the <code>getBySlug()</code> static method inside our Chapter model. </p>
<p>Open <code>server/models/Chapter.js</code> and find the <code>getBySlug()</code> static method:</p>
<pre><code>static async get<span class="hljs-constructor">BySlug({ <span class="hljs-params">bookSlug</span>, <span class="hljs-params">chapterSlug</span> })</span> {
  const book = await <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Book</span>.</span></span>get<span class="hljs-constructor">BySlug({ <span class="hljs-params">slug</span>: <span class="hljs-params">bookSlug</span> })</span>;
  <span class="hljs-keyword">if</span> (!book) {
    throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">Error('Book <span class="hljs-params">not</span> <span class="hljs-params">found</span>')</span>;
  }

  const chapter = await this.find<span class="hljs-constructor">One({ <span class="hljs-params">bookId</span>: <span class="hljs-params">book</span>.<span class="hljs-params">_id</span>, <span class="hljs-params">slug</span>: <span class="hljs-params">chapterSlug</span> })</span>;

  <span class="hljs-keyword">if</span> (!chapter) {
    throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">Error('Chapter <span class="hljs-params">not</span> <span class="hljs-params">found</span>')</span>;
  }

  const chapterObj = chapter.<span class="hljs-keyword">to</span><span class="hljs-constructor">Object()</span>;
  chapterObj.book = book;

  return chapterObj;
}</code></pre><p><a target="_blank" href="https://builderbook.org/books/builder-book/book-and-chapter-models-internal-api-render-chapter#express-route" rel="noopener noreferrer">In Chapter 5</a>, when we wrote the <code>getBySlug</code> static method, we passed <code>userId</code> and <code>isAdmin</code> parameters to this method from corresponding Express route. But we haven't used them yet (though we mentioned that we would in Chapter 8).</p>
<p>Add these two parameters in the <code>getBySlug()</code> function like this:</p>
<pre><code><span class="hljs-keyword">static</span> async getBySlug({
  bookSlug, chapterSlug, userId, <span class="hljs-built_in">isAdmin</span>,
})</code></pre><p>Now, let's modify the <code>getBySlug</code> static method by adding code that checks whether the chapter <code>isPurchased</code>. We'll add the code <em>before</em> we return chapterObj with <code>return chapterObj</code>. Follow the example from our <code>Book.buy()</code> static method located at <code>server/models/Book.js</code>. There, we defined <code>isPurchased</code> like this:</p>
<pre>const isPurchased = (await Purchase.find({ userId: user._id, bookId: id }).countDocuments()) &gt; 0;</pre>

<p>Here, we will make some slight changes. We will check:</p>
<ul>
<li>that the purchase document exists (<code>Purchase.findOne({ userId, bookId: book._id })</code>)</li>
<li>whether a user is Admin (<code>isAdmin</code>),</li>
<li>whether the chapter is free (<code>chapter.isFree</code>)</li>
</ul>
<p>To check for all three, you may get something like this:</p>
<pre><code><span class="hljs-keyword">if</span> (userId) {
  const purchase = await <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Purchase</span>.</span></span>find<span class="hljs-constructor">One({ <span class="hljs-params">userId</span>, <span class="hljs-params">bookId</span>: <span class="hljs-params">book</span>.<span class="hljs-params">_id</span> })</span>;

  chapterObj.isPurchased = !!purchase<span class="hljs-operator"> || </span>isAdmin;
}

const isFreeOrPurchased = chapter.isFree<span class="hljs-operator"> || </span>chapterObj.isPurchased;

<span class="hljs-keyword">if</span> (!isFreeOrPurchased) {
  delete chapterObj.htmlContent;
}</code></pre><p>First note - <code>chapterObj.isPurchased</code> is true if a purchase exists or if a user is Admin.</p>
<p>Second note - we <em>remove</em> the full content of <code>htmlContent</code> from the <code>chapterObj</code> object when <code>chapterObj.isFreeOrPurchased</code> is false. If a chapter is not free and not purchased, then <code>chapterObj</code> will <em>not contain</em> <code>htmlContent</code>. This is a very important step, since our app renders <code>ReadChapter</code> page initially <em>on the server</em>. Writing conditional logic that hides full content on the client is <em>not</em> sufficient that's why we added above server-side logic.</p>
<p>Add the above code snippet to the <code>getBySlug</code> method in our Chapter model. Paste the snippet above this line of code:</p>
<pre>return chapterObj;</pre>

<p>Remember to import the Purchase model to <code>server/models/Chapter.js</code> with:</p>
<pre>const Purchase = require('./Purchase');</pre>


<p>Great, we have <em>both</em> boolean parameters we wanted: <code>chapter.isFree</code> and <code>chapter.isPurchased</code>!</p>
<p>Writing a conditional construct inside the <code>ReadChapter</code> page will be easy. Open <code>pages/public/read-chapter.js</code> and find two places where we defined <code>htmlContent</code>. First, inside <code>constructor</code> :</p>
<pre><code><span class="hljs-attribute">let</span> htmlContent = <span class="hljs-string">''</span>;
<span class="hljs-attribute">if</span> (chapter) {
  <span class="hljs-attribute">htmlContent</span> = chapter.htmlContent;
}</code></pre><p>Second, inside <code>componentWillReceiveProps()</code>:</p>
<pre><code><span class="hljs-section">const</span> { <span class="hljs-attribute">htmlContent</span> } = chapter;</code></pre><p>Replace <em>both</em> of these definitions of <code>htmlContent</code> with:</p>
<pre><code><span class="hljs-attribute">let</span> htmlContent = <span class="hljs-string">''</span>;
<span class="hljs-attribute">if</span> (chapter &amp;&amp; (chapter.isPurchased || chapter.isFree)) {
  <span class="hljs-attribute">htmlContent</span> = chapter.htmlContent;
} <span class="hljs-section">else</span> {
  <span class="hljs-attribute">htmlContent</span> = chapter.htmlExcerpt;
}</code></pre><p>The condition <code>(chapter.isPurchased || chapter.isFree)</code> ensures that we show the full content of <code>chapter.htmlContent</code> <em>only</em> in the following cases:</p>
<ul>
<li>user bought the book</li>
<li>user is an Admin</li>
<li>Admin user specifies <code>isFree: true</code> in the metadata of a <code>.md</code> file</li>
</ul>
<h4 style="color: #FFF;">
        <a name="buybutton" href="#buybutton" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        BuyButton
      </h4><p>Now that we've set up conditions for showing free or paid content to particular users, let's add a buy button to appear on paid books.</p>
<p>Go to the <code>ReadChapter</code> page. Open the <code>pages/public/read-chapter.js</code> file and import the <code>BuyButton</code> component:</p>
<pre>import BuyButton from '../../components/customer/BuyButton';</pre>

<p>In the same file, find the <code>renderMainContent()</code> function. Inside this function, find the element:</p>
<pre><code>&lt;div
  // eslint-disable-<span class="hljs-keyword">next</span>-<span class="hljs-built_in">line</span> react/<span class="hljs-keyword">no</span>-danger
  dangerouslySetInnerHTML={{ __htm<span class="hljs-variable">l:</span> htmlContent }}
/&gt;</code></pre><p>Under this element, which is <code>htmlContent</code>, add the buy button (<code>BuyButton</code> component):</p>
<pre><code>{!chapter.isPurchased &amp;&amp; !chapter.isFree ? (
  &lt;BuyButton user={user} book={chapter.book} /&gt;
) : null}</code></pre><p>This conditional construct ensures that a page does not display the buy button on a chapter when <code>chapter.isPurchased</code> or <code>chapter.isFree</code> is true.</p>
<p>We pass <code>user</code>, <code>book</code>, and <code>showModal</code> props to our <code>BuyButton</code> component. We have already defined the props <code>user</code> and <code>book</code> inside the <code>ReadChapter</code> page component. Go ahead and find them:</p>
<ul>
<li>we defined a <code>user</code> constant inside the <code>render()</code> method as <code>const { user } = this.props;</code>, since we pass <code>user</code> prop to the <code>Header</code> component</li>
<li>we defined a <code>book</code> constant inside the <code>renderSidebar()</code> function as <code>const { book } = chapter;</code>, we use <code>book</code> for <code>book.slug</code></li>
</ul>
<p>So we know how to define <code>user</code> and <code>book</code> inside the local scope of the <code>renderMainContent()</code> function:</p>
<pre><code>renderMainContent() {
  const { user } = this.props;

  const {
    chapter, htmlContent, showTOC, isMobile,
  } = this.state;

  const { book } = chapter;

  let padding = <span class="hljs-string">'20px 20%'</span>;
  if (!isMobile &amp;&amp; showTOC) {
    padding = <span class="hljs-string">'20px 10%'</span>;
  } else if (isMobile) {
    padding = <span class="hljs-string">'0px 10px'</span>;
  }

  return (
    &lt;div style={{ padding }} id=<span class="hljs-string">"chapter-content"</span>&gt;
      &lt;h2 style={{ fontWeight: <span class="hljs-string">'400'</span>, lineHeight: <span class="hljs-string">'1.5em'</span> }}&gt;
        {chapter.order &gt; <span class="hljs-number">1</span> ? `Chapter ${chapter.order - <span class="hljs-number">1</span>}: ` : null}
        {chapter.title}
      &lt;/h2&gt;
      &lt;div
        // eslint-disable-next-line react/no-danger
        dangerouslySetInnerHTML={{ __html: htmlContent }}
      /&gt;
      {!chapter.isPurchased &amp;&amp; !chapter.isFree ? (
        &lt;BuyButton user={user} book={book} /&gt;
      ) : null}
    &lt;/div&gt;
  );
}</code></pre><p>Time to test.</p>
<h4 style="color: #FFF;">
        <a name="testing" href="#testing" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Testing
      </h4><p>We should make UX improvements to our checkout flow, but before we do, let's test the code we wrote so far in this chapter.</p>
<p>Start your app with <code>yarn dev</code>, log in with a <em>non-Admin</em> user, and navigate to </p><pre><a target="_blank" href="http://localhost:8000/books/demo-book/example" rel="noopener noreferrer">http://localhost:8000/books/demo-book/example</a></pre><p></p>
<p>As expected, you will see <code>chapter.htmlExcerpt</code> and the <code>BuyButton</code> component!<br><img src="https://user-images.githubusercontent.com/10218864/36943901-685bd918-1f46-11e8-8649-d85886211d92.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Log out, and log in with an <code>Admin</code> user (if you have only one Google account, set <code>"isAdmin": true</code> on your user document at MongoDB).</p>
<p>Navigate to <code>http://localhost:8000/books/demo-book/example</code>.<br>As expected, the page displays the full content of <code>chapter.htmlContent</code>, and the <code>BuyButton</code> component has disappeared:<br><img src="https://user-images.githubusercontent.com/10218864/36943925-f3a2ad3a-1f46-11e8-8ce8-60b48eb0f88a.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>If you try to test the checkout flow, it will fail with the error <code>Not found</code>. The <code>Book.buy()</code> method fails because the EmailTemplate document with the name <code>purchase</code> can't be found in our database.</p>
<p>To make our app create this missing EmailTemplate document, you need to go to Atlas and <em>delete</em> the current <code>emailtemplates</code> collection. Then stop your app and start it again with <code>yarn dev</code>. Check the newly created <code>emailtemplates</code> collection - it will contain two documents with the names <code>welcome</code> and <code>purchase</code>. Now we are ready for testing the checkout flow.</p>
<p>Notice that at this point your database has no <code>purchases</code> collection.</p>
<p>Log out and log in with a <em>non-Admin</em> user again (or remove <code>"isAdmin": true</code> from your user document at MongoDB).<br>Navigate to <code>http://localhost:8000/books/demo-book/example</code>.<br>Click the <code>Buy book</code> button and you will see the Stripe modal:<br><img src="https://user-images.githubusercontent.com/10218864/36943969-8aadc534-1f47-11e8-9ecd-0a0723678fc8.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>In test mode, Stripe suggests using the card number 4242 4242 4242 4242 with any CVC (why not 4242) and any date in the future.<br>Click the <code>Pay $49</code> button on the Stripe modal, and you will see a <code>Success!</code> in-app message. Then <em>after reloading</em> the page, you will see the full content:<br><img src="https://user-images.githubusercontent.com/10218864/36944140-edd07500-1f4a-11e8-982e-dc6558804d55.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>In your database, the app created a new collection called <code>purchases</code>. The very first Purchase document looks like:<br><img src="https://user-images.githubusercontent.com/10218864/36944152-2906aa18-1f4b-11e8-9736-34ffc7dec561.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Success, the checkout flow indeed works.</p>
<p>Reloading a page manually to see the full content is not a good UX. In the next section, we will reload the page automatically and make a few more UX improvements.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="checkout-ux" href="#checkout-ux" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="checkout-ux">
          Checkout UX
        </span>
      </h2><p>In the previous section, we implemented a checkout flow and showed that it works as expected. However, a few experiences inside our checkout flow are not smooth. For example:</p>
<ol>
<li>After you buy a book, you have to <em>manually</em> refresh the page in order to see the full content.</li>
<li>If you are logged out while viewing the <code>ReadChapter</code> page and then log in, you will be redirected to the <code>MyBooks</code> page. It would be better to redirect <em>back</em> to the <code>ReadChapter</code> page.</li>
<li>If you are logged out and click the <code>Buy book</code> button (on the <code>ReadChapter</code> page), you will be redirected to the <code>MyBooks</code> page. It would be better to redirect <em>back</em> to the <code>ReadChapter</code> page you were reading when you clicked the <code>Buy book</code> button.</li>
<li>If you are logged out and click the <code>Buy book</code> button, you have to sign in and then click the <code>Buy book</code> button <em>again</em>. It would better to see the Stripe modal right after logging in, so you only need to click the <code>Buy Book</code> button <em>once</em>.</li>
</ol>
<p>Let's discuss how we will solve each of the UX problems above.</p>
<ol>
<li><p>You may think of at least two ways to solve this problem. Ultimately, the goal is to re-run the <code>getInitialProps()</code> method inside the <code>ReadChapter</code> page (<code>pages/public/read-chapter.js</code>). Re-rendering a component with <code>setState()</code> will <em>not</em> trigger <code>getInitialProps()</code> to execute again. We need to re-run the <code>getInitialProps()</code> method to add <code>htmlContent</code> parameter to the <code>chapterObj</code> so full content can be displayed on the page. One complication is that, to re-run <code>getInitialProps()</code>, we need to pass <code>headers.cookie</code> to <code>getInitialProps()</code> again. We have to save <code>headers.cookie</code> in props.</p>
<p>Here is the reason why the <code>getInitialProps()</code> method requires <code>cookie</code> as an argument. As discussed earlier in <a target="_blank" href="https://builderbook.org/books/builder-book/server-database-session-header-and-menudrop-components#session" rel="noopener noreferrer">Chapter 2, section Session</a>, the server needs a cookie to identify a session. Then the server uses session to get a user id, and finally the server uses user id to get a user from <code>req.user</code>. In our <code>Book.buy()</code> static method (<code>server/models/Book.js</code>), we use <code>user</code> and <code>user.isAdmin</code> to see if a user bought a book or if a user is an Admin.</p>
<p>A simpler solution is to trigger a window reload after the <code>buyBook()</code> API method has executed. Open <code>components/customer/BuyButton.js</code> and find this snippet:</p>
<pre><code><span class="hljs-keyword">try</span> {
 await buy<span class="hljs-constructor">Book({ <span class="hljs-params">stripeToken</span>: <span class="hljs-params">token</span>, <span class="hljs-params">id</span>: <span class="hljs-params">book</span>.<span class="hljs-params">_id</span> })</span>;
 notify('Success!');
 <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NProgress</span>.</span></span><span class="hljs-keyword">done</span><span class="hljs-literal">()</span>;
} catch (err) {
 <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NProgress</span>.</span></span><span class="hljs-keyword">done</span><span class="hljs-literal">()</span>;
 notify(err);
}</code></pre><p>As you know from <a target="_blank" href="https://builderbook.org/books/builder-book/authentication-hoc-promise-async-await-static-method-for-user-model-google-oauth#async-await" rel="noopener noreferrer">Chapter 3, section Async/await</a>, the code pauses at the line with <code>await buyBook()</code>. After this line, add a new line:<br><code>window.location.reload(true);</code></p>
<p>This method <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/API/Location/reload" rel="noopener noreferrer">location.reload(true)</a> reloads a page from the server.</p>
</li>
<li><p>Imagine you bought a book but you logged out of the app. Say you go back to Chapter 2 of the book. Let's modify the code so that when you click the <code>Log in</code> link (in the <code>Header</code>) and log in with Google, you'll be <em>automatically</em> redirected <em>back</em> to Chapter 2 <em>instead</em> of the <code>MyBooks</code> page.</p>
<p>Take a look at the code responsible for redirecting a user after Google login at <code>server/google.js</code>. Find this anonymous arrow function:</p>
<pre><code>(req, res) =&gt; {
 <span class="hljs-meta">if</span> (req.user <span class="hljs-variable">&amp;&amp;</span> req.user.isAdmin) {
   res.<span class="hljs-meta">redirect</span>(<span class="hljs-string">'/admin'</span>);
 } <span class="hljs-meta">else</span> {
   res.<span class="hljs-meta">redirect</span>(<span class="hljs-string">'/my-books'</span>);
 }
},</code></pre><p>We need to modify the above conditional logic. We still want to redirect an Admin user to <code>/admin</code>. But a Customer user should be redirected to the <code>ReadChapter</code> page <em>if</em> the user clicked the <code>Log in</code> link or <code>Buy book</code> button <em>while</em> on the <code>ReadChapter</code> page.</p>
<p>We suggest creating a new parameter, <code>redirectUrl</code>, that contains the URL of the <code>ReadChapter</code> page.</p>
<p>We can <em>append</em> this <code>redirectUrl</code> value to the <code>Login</code> page URL (<code>/login</code>) and Google OAuth URL (<code>/auth/google</code>). Then, after a user logs in, we can <em>read</em> <code>redirectUrl</code> from the appended URL and redirect a user <em>back</em> to the <code>ReadChapter</code> page. For example, for the URL:</p>
<pre>https://builderbook.org/books/builder-book/table-of-contents-highlight-for-section-hide-header-mobile-browser</pre>

<p>The <code>redirectUrl</code> would be:</p>
<pre>%2Fbooks%2Fbuilder-book%2Ftable-of-contents-highlight-for-section-hide-header-mobile-browser</pre>

<p>URL encoded <code>%2F</code> stands for slash <code>/</code>.</p>
<p>First, let's work on the redirect when a user clicks the <code>Log in</code> link inside the <code>Header</code> component. Open <code>server/google.js</code> and find the <code>/auth/google</code> Express route:</p>
<pre><code><span class="hljs-selector-tag">server</span><span class="hljs-selector-class">.get</span>(
 <span class="hljs-string">'/auth/google'</span>,
 passport.authenticate(<span class="hljs-string">'google'</span>, {
   <span class="hljs-attribute">scope</span>: [<span class="hljs-string">'profile'</span>, <span class="hljs-string">'email'</span>],
   <span class="hljs-attribute">prompt</span>: <span class="hljs-string">'select_account'</span>,
 }),
);</code></pre><p>We want to re-write this route in order to save a <code>redirectUrl</code> string value to the <code>req.session</code> object <em>before</em> calling <code>passport.authenticate('google')</code>. We want both <code>req.query</code> and <code>req.query.redirectUrl</code> to exist and make sure that the latter starts with <code>/</code>. We do so with the JavaScript method <a target="_blank" href="(https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/startsWith)." rel="noopener noreferrer">startsWith('/')</a> that outputs true or false:</p>
<pre><code><span class="hljs-keyword">if</span> (req.query &amp;&amp; req.query.redirectUrl &amp;&amp; req.query.redirectUrl.startsWith(<span class="hljs-string">'/'</span>)) {
 req.<span class="hljs-keyword">session</span>.finalUrl = req.query.redirectUrl;
} <span class="hljs-keyword">else</span> {
 req.<span class="hljs-keyword">session</span>.finalUrl = <span class="hljs-keyword">null</span>;
}</code></pre><p>If all three conditions are true, we <em>save</em> <code>redirectUrl</code> to our session object as <code>req.session.finalUrl</code>.<br>The updated Express route will look like:</p>
<pre><code>server.get(<span class="hljs-string">'/auth/google'</span>, <span class="hljs-function"><span class="hljs-params">(req, res, <span class="hljs-built_in">next</span>)</span> =&gt;</span> {
 <span class="hljs-keyword">if</span> (req.query &amp;&amp; req.query.redirectUrl &amp;&amp; req.query.redirectUrl.startsWith(<span class="hljs-string">'/'</span>)) {
   req.session.finalUrl = req.query.redirectUrl;
 } <span class="hljs-keyword">else</span> {
   req.session.finalUrl = null;
 }

 passport.authenticate(<span class="hljs-string">'google'</span>, {
   <span class="hljs-name">scope</span>: [<span class="hljs-string">'profile'</span>, <span class="hljs-string">'email'</span>],
   <span class="hljs-name">prompt</span>: <span class="hljs-string">'select_account'</span>,
 })(req, res, <span class="hljs-built_in">next</span>);
});</code></pre><p>Third argument <code>next</code> in the above middleware functions ensures that Express passes control to <em>downstream</em> middleware function since these the above middleware functions do not end request-response cycle (for example, they don't send any response to user).</p>
<p>At this point, we saved a <code>redirectUrl</code> value to <code>req.session</code>. The next step is to use it for an actual redirect. In the same file, find this function inside the <code>/oauth2callback</code> Express route:</p>
<pre><code>(req, res) =&gt; {
 <span class="hljs-meta">if</span> (req.user <span class="hljs-variable">&amp;&amp;</span> req.user.isAdmin) {
   res.<span class="hljs-meta">redirect</span>(<span class="hljs-string">'/admin'</span>);
 } <span class="hljs-meta">else</span> {
   res.<span class="hljs-meta">redirect</span>(<span class="hljs-string">'/my-books'</span>);
 }
},</code></pre><p><em>Before</em> the <code>else</code> condition, we should add an <code>else if</code> condition to redirect a user to <code>req.session.finalUrl</code> with <code>res.redirect(req.session.finalUrl)</code>:</p>
<pre><code><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.<span class="hljs-keyword">session</span>.finalUrl) {
 res.redirect(req.<span class="hljs-keyword">session</span>.finalUrl);
}</code></pre><p>Updated function:</p>
<pre><code>(req, res) =&gt; {
 <span class="hljs-keyword">if</span> (req.<span class="hljs-keyword">user</span> &amp;&amp; req.<span class="hljs-keyword">user</span>.isAdmin) {
   res.redirect(<span class="hljs-string">'/admin'</span>);
 } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.<span class="hljs-keyword">session</span>.finalUrl) {
   res.redirect(req.<span class="hljs-keyword">session</span>.finalUrl);
 } <span class="hljs-keyword">else</span> {
   res.redirect(<span class="hljs-string">'/my-books'</span>);
 }
},</code></pre><p>This conditional logic redirects an Admin user to <code>/admin</code> and redirects a Customer user to <code>req.session.redirectUrl</code> if <code>req.query.redirectUrl</code> exists. However, based on the last statement, our redirect feature does not work yet. It will only work when <code>req.query</code> (i.e. the part of the URL after <code>?redirectUrl=</code>) has a value (see how we defined <code>req.session.finalUrl</code> earlier). Our next step is to engineer <code>req.query.redirectUrl</code>.</p>
<p>Let's keep in mind what we want to achieve. We want a user who is on the <code>ReadChapter</code> page and who clicks the <code>Log in</code> link in the <code>Header</code> component to be redirected back to the same <code>ReadChapter</code> page after logging in. That means that:</p>
<ul>
<li>The URL of the <code>Login</code> page <em>must</em> contain the <code>?redirectUrl=</code> query with a value.</li>
<li>Once the URL of the <code>Login</code> page has this query, the app will be able to read the query value and pass it to <code>/auth/google?redirectUrl=</code>.</li>
<li>After that, the updated Express route <code>server.get('/auth/google)</code> will take care of the rest.</li>
</ul>
<p>Start your app and make sure you are logged out. Go to Chapter 1 (titled "Example") of the <a target="_blank" href="https://github.com/builderbook/demo-book" rel="noopener noreferrer">demo-book</a> repo you forked earlier. The URL of this page is:</p>
<pre>http://localhost:8000/books/demo-book/example</pre>

<p>We want to make sure that when you click <code>Log in</code> in the <code>Header</code>, the URL of the Login page is:</p>
<pre>http://localhost:8000/public/login?redirectUrl=%2Fbooks%2Fdemo-book%2Fexample</pre>

<p>Instead of:</p>
<pre>http://localhost:8000/public/login</pre>

<p>The easiest way to achieve this is to pass the <code>redirectUrl</code> prop from the <code>ReadChapter</code> page to the <code>Header</code> component. Let's make neccesary changes to <code>ReadChapter</code> and <code>Header</code>.</p>
<ul>
<li><p>In <code>pages/public/read-chapter.js</code>, make the following 3 changes:</p>
<ol>
<li><p>To <code>static PropTypes</code>, add a new <code>router</code> prop:</p>
<pre><code><span class="hljs-selector-tag">router</span>: <span class="hljs-selector-tag">PropTypes</span><span class="hljs-selector-class">.shape</span>({
<span class="hljs-attribute">asPath</span>: PropTypes.string.isRequired,
})<span class="hljs-selector-class">.isRequired</span>,</code></pre></li>
<li><p>Inside the main <code>render()</code> method, define a <code>prop</code> variable as <code>this.props.router</code>:<br><code>const { user, router } = this.props;</code> </p>
</li>
<li><p>Pass a <code>router.asPath</code> value to the <code>redirectUrl</code> prop on the <code>Header</code> component like this:</p>
<pre>Header user={user} hideHeader={hideHeader} redirectUrl={router.asPath}</pre>

<p>Read about <code>router</code> object, its type, and its <code>asPath</code> parameter in the Next.js <a target="_blank" href="https://github.com/zeit/next.js/#using-a-higher-order-component" rel="noopener noreferrer">docs for router object</a>.<br>In our case, <code>router.asPath</code> is <code>/books/demo-book/example</code>.<br>If in doubt, print this value to the browser console (<code>Developer tools &gt; Console</code>) by adding <code>console.log(router.asPath);</code> after <code>const { user, router } = this.props;</code> inside <code>render()</code> of the <code>pages/public/read-chapter.js</code> file.</p>
<p>Add import:</p>
<pre>import { withRouter } from 'next/router';</pre>

<p>Then add <code>router</code> prop to props:</p>
<pre><code>static propTypes = {
chapter: <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropTypes</span>.</span></span>shape({
  _id: <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropTypes</span>.</span></span><span class="hljs-built_in">string</span>.isRequired,
}),
user: <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropTypes</span>.</span></span>shape({
  _id: <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropTypes</span>.</span></span><span class="hljs-built_in">string</span>.isRequired,
}),
router: <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropTypes</span>.</span></span>shape({
  asPath: <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">PropTypes</span>.</span></span><span class="hljs-built_in">string</span>.isRequired,
}).isRequired,
};</code></pre><p>Remember to wrap <code>ReadChapter</code> page component with <code>withRouter</code> to pass <code>router</code> prop to <code>ReadChapter</code> component:</p>
<pre><code><span class="hljs-builtin-name">export</span><span class="hljs-built_in"> default </span>withAuth(withRouter(ReadChapter), {
loginRequired: <span class="hljs-literal">false</span>,
});</code></pre></li>
</ol>
</li>
<li><p>In <code>components/Header.js</code>, make the following 3 changes:</p>
<ol>
<li><p>Add a <code>redirectUrl</code> prop to the <code>Header</code> function:</p>
<pre>function Header({ user, hideHeader, redirectUrl })</pre></li>
<li><p>Update the <code>href</code> value in the <code>&lt;Link&gt;</code> element for <code>Log in</code>. It becomes:</p>
<pre><code>&lt;Link
prefetch
href={{ pathname: <span class="hljs-string">'/public/login'</span>, asPath: <span class="hljs-string">'/login'</span>, query: { redirectUrl } }}&gt;
&lt;a style={{ margin: <span class="hljs-string">'0px 20px 0px auto'</span> }}&gt;Log <span class="hljs-keyword">in</span>&lt;/a&gt;
&lt;/Link&gt;</code></pre><p>We specified that query is a value after <code>?redirectUrl=</code> with this <a target="_blank" href="https://eslint.org/docs/rules/object-shorthand" rel="noopener noreferrer">property shorthand</a>: <code>query: { redirectUrl }</code>.</p>
</li>
<li><p>Add the <code>redirectUrl</code> prop to <code>propTypes</code> and <code>defaultProps</code>. Add <code>redirectUrl: PropTypes.string</code> and <code>redirectUrl: ''</code> to <code>propTypes</code> and <code>defaultProps</code> blocks respectively.</p>
</li>
</ol>
</li>
</ul>
<p>We are ready to test.<br>Start your app. While logged out, go to <code>http://localhost:8000/books/demo-book/example</code>.<br>Click the <code>Log in</code> link in the <code>Header</code>. You will be redirected to the <code>Login page</code> that has URL:</p>
<pre>http://localhost:8000/public/login?redirectUrl=%2Fbooks%2Fdemo-book%2Fexample</pre>

<p><img src="https://user-images.githubusercontent.com/10218864/36952085-f5476954-1fbf-11e8-88e6-0835ef698596.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"><br>It almost works!</p>
<p><code>query</code> parameter is added to the URL, however <code>asPath</code> parameter did not work: we still see <code>/public/login/...</code> instead of <code>/login/...</code>.<br>As we found out after writing this book, <a target="_blank" href="https://github.com/zeit/next.js#with-url-object" rel="noopener noreferrer">asPath</a> on <code>Link</code> component does not work and work around is to pass <code>as</code> to <code>Link</code>:</p>
<pre><code>&lt;Link
 prefetch
 href={{ pathname: <span class="hljs-string">'/public/login'</span>, query: { redirectUrl } }}&gt;
 <span class="hljs-keyword">as</span>={{ pathname: <span class="hljs-string">'/login'</span>, query: { redirectUrl } }}&gt;
 &lt;a style={{ margin: <span class="hljs-string">'0px 20px 0px auto'</span> }}&gt;Log <span class="hljs-keyword">in</span>&lt;/a&gt;
&lt;/Link&gt;</code></pre><p>Pass <code>as</code> object to <code>Link</code> component as it shown in the above snippet.<br>Go to <code>http://localhost:8000/books/demo-book/example</code> and click on <code>Log in</code> link inside the <code>Header</code>.<br>Now browser will show you proper URL:</p>
<pre>http://localhost:8000/login?redirectUrl=%2Fbooks%2Fdemo-book%2Fexample</pre>


</li>
</ol>
<p>  Try clicking the red <code>Log in with Google</code> button and log in as a Customer (non-Admin) user. Login worked but you <em>are not</em> be redirected back to Chapter 1. That's because we did not pass the <code>redirectUrl</code> query to the <code>/auth/google</code> route yet.</p>
<p>  Open <code>pages/public/login.js</code> and make these 4 changes:</p>
<ol>
<li><p>Rewrite <code>Login</code> as a function instead of a constant</p>
</li>
<li><p>Add the <code>router</code> prop to <code>Login.propTypes</code></p>
</li>
<li><p>Define <code>redirectUrl</code> as:</p>
<pre>const redirectUrl = (router &amp;&amp; router.query &amp;&amp; router.query.redirectUrl) || '';</pre></li>
<li><p>Pass <code>redirectUrl</code> to the <code>href</code> attribute of the <code>&lt;Button&gt;</code> element with:</p>
<pre>/auth/google?redirectUrl=${redirectUrl}</pre></li>
<li><p>Wrap <code>Login</code> page component with <code>withRouter</code> HOC so <code>Login</code> receives <code>router</code> prop.</p>
<p>After all changes, the updated <code>pages/public/login.js</code> file is:<br><code>pages/public/login.js</code> :</p>
<pre><code><span class="hljs-keyword">import</span> Head <span class="hljs-keyword">from</span> <span class="hljs-string">'next/head'</span>;
<span class="hljs-keyword">import</span> { withRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;
<span class="hljs-keyword">import</span> PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>;
<span class="hljs-keyword">import</span> Button <span class="hljs-keyword">from</span> <span class="hljs-string">'@material-ui/core/Button'</span>;

<span class="hljs-keyword">import</span> withAuth <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/withAuth'</span>;
<span class="hljs-keyword">import</span> { styleLoginButton } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../components/SharedStyles'</span>;

<span class="hljs-keyword">function</span> Login({ router }) {
<span class="hljs-keyword">const</span> redirectUrl = (router &amp;&amp; router.query &amp;&amp; router.query.redirectUrl) || <span class="hljs-string">''</span>;

<span class="hljs-keyword">return</span> (
 &lt;div style={{ textAlign: <span class="hljs-string">'center'</span>, margin: <span class="hljs-string">'0 20px'</span> }}&gt;
   &lt;Head&gt;
     &lt;title&gt;
       Log <span class="hljs-keyword">in</span> <span class="hljs-keyword">to</span> Builder Book
     &lt;/title&gt;
     &lt;meta name=<span class="hljs-string">"description"</span> content=<span class="hljs-string">"Login page for builderbook.org"</span> /&gt;
   &lt;/Head&gt;
   &lt;br /&gt;
   &lt;p style={{ margin: <span class="hljs-string">'45px auto'</span>, fontSize: <span class="hljs-string">'44px'</span>, fontWeight: <span class="hljs-string">'400'</span> }}&gt;
     Log <span class="hljs-keyword">in</span>
   &lt;/p&gt;
   &lt;p&gt;
     You’ll be logged <span class="hljs-keyword">in</span> <span class="hljs-keyword">for</span> <span class="hljs-number">14</span> days <span class="hljs-keyword">unless</span> you log out manually.
   &lt;/p&gt;
   &lt;br /&gt;
   &lt;Button
     variant=<span class="hljs-string">"contained"</span>
     style={styleLoginButton}
     href={`/auth/google?redirectUrl=${redirectUrl}`}
   &gt;
     &lt;img
       src=<span class="hljs-string">"https://storage.googleapis.com/builderbook/G.svg"</span>
       alt=<span class="hljs-string">"Log in with Google"</span>
       style={{ marginRight: <span class="hljs-string">'10px'</span> }}
     /&gt;
     Log <span class="hljs-keyword">in</span> <span class="hljs-keyword">with</span> Google
   &lt;/Button&gt;
 &lt;/div&gt;
);
}

Login.propTypes = {
router: PropTypes.shape({
 query: PropTypes.shape({
   redirectUrl: PropTypes.string,
 }),
}).isRequired,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> withAuth(withRouter(Login), { logoutRequired: <span class="hljs-literal">true</span> });</code></pre><p>Now we can test this entire new feature.<br>Start your app. While logged out, go to:</p>
<pre>http://localhost:8000/books/demo-book/example</pre>
<p>Click <code>Log in</code> in the <code>Header</code>. You will be redirected to the <code>Login page</code> with this URL:</p>
<pre>http://localhost:8000/public/login?redirectUrl=%2Fbooks%2Fdemo-book%2Fexample</pre>
<p>Hover your cursor over the <code>Log in with Google</code> button, and you will see the following URL in the bottom-left corner of your browser window:</p>
<pre>http://localhost:8000/auth/google?redirectUrl=/books/demo-book/example</pre>

<p>Log in as a Customer (non-Admin) user, and you will be redirected back to:</p>
<pre>http://localhost:8000/books/demo-book/example</pre>

<p>Hooray!</p>
</li>
</ol>
<ol start="3">
<li><p>The next step is to work on a slightly different redirect - taking a user back to the <code>ReadChapter</code> page when a logged-out user clicks the <code>Buy book</code> button. We've actually written most of the code for this feature. We will rely on the code we added to <code>server/google.js</code>. That means that we need to add a <code>redirectUrl</code> query to the URL when a logged-out user clicks the <code>Buy book</code> button on the <code>ReadChapter</code> page.</p>
<p>Do you remember which function handles a click on <code>Buy book</code> from a logged-out user? It's the <code>onLoginClicked</code> function from the <code>BuyButton</code> component (<code>components/customer/BuyButton.js</code>):</p>
<pre><code><span class="hljs-function"><span class="hljs-title">onLoginClicked</span> = <span class="hljs-params">()</span> =&gt;</span> {
 const { user } = <span class="hljs-keyword">this</span>.props;

 <span class="hljs-keyword">if</span> (!user) {
   <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'/auth/google'</span>;
 }
};</code></pre><p>We need to make sure that <code>/auth/google</code> gets the <code>redirectUrl</code> query. In this local scope, define <code>redirectUrl</code> as <a target="_blank" href="https://www.w3schools.com/jsref/prop_loc_pathname.asp" rel="noopener noreferrer">location.pathname</a>.</p>
<p><code>location.pathname</code> gives the same value as Next.js's <code>router.asPath</code> (see above). It's the part of the URL without the domain root:</p>
<pre>const redirectUrl = window.location.pathname;</pre>

<p>Append the value of <code>redirectUrl</code> to <code>/auth/google?redirectUrl=</code>. Set the page's URL to this appended URL by using <a target="_blank" href="https://www.w3schools.com/jsref/prop_loc_href.asp" rel="noopener noreferrer">location.href</a>:</p>
<pre><code><span class="hljs-keyword">const</span> redirectUrl = <span class="hljs-built_in">window</span>.location.pathname;
<span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">`/auth/google?redirectUrl=<span class="hljs-subst">${redirectUrl}</span>`</span>;</code></pre><p>Updated <code>onLoginClicked</code> function:</p>
<pre><code>onLoginClicked = () =&gt; {
 const {<span class="hljs-built_in"> user </span>} = this.props;

 <span class="hljs-keyword">if</span> (!user) {
   const redirectUrl = window.location.pathname;
   window.location.href = `/auth/google?<span class="hljs-attribute">redirectUrl</span>=<span class="hljs-variable">${redirectUrl}</span>`;
 }
};</code></pre><p>Time to test it out.</p>
<p>Make sure you are logged out and navigate to: <code>http://localhost:8000/books/demo-book/example</code><br>Click on the blue <code>Buy book</code> button.<br>You will see the Google OAuth prompt. After logging in (as a Customer), you will be automatically redirected back to:</p>
<pre>http://localhost:8000/books/demo-book/example</pre>

<p>Good job.</p>
<p>The only part that still sucks, UX-wise, is that the Stripe modal did not appear automatically. You clicked the <code>Buy book</code> button because you intend to buy a book. But our app requires you to click <code>Buy book</code> one more time. That's annoying.</p>
</li>
<li><p>To show the Stripe modal to a user who clicked on the <code>Buy book</code> button while logged out, we need to somehow change the value of the <code>showModal</code> prop inside the <code>BuyButton</code> component. We need to detect that a logged-user clicked the <code>Buy book</code> button on the <code>ReadChapter</code> page. Then we need to pass a <code>showModal</code> prop with the value <code>true</code> from the <code>ReadChapter</code> page to the <code>BuyButton</code> component.<br>Earlier in this chapter, we set the initial state of the <code>Buy book</code> component with:</p>
<pre><code>this.<span class="hljs-keyword">state</span> = {
 showModal: !!props.showModal,
};</code></pre><p>This code ensures that <code>showModal</code> from the <code>ReadChapter</code> page has the same value as <code>showModal</code> in the scope of the <code>BuyButton</code> component.</p>
<p>The question is <em>when</em> should the <code>ReadChapter</code> page pass this <code>showModal</code> prop to the <code>BuyButton</code> component?</p>
<p>An easy solution is to modify our <code>onLoginClicked</code> function so that <code>/auth/google?redirectUrl=${redirectUrl}</code> is <em>further</em> appended with a unique query, say <code>?buy=1</code>. Inside our <code>onLoginClicked</code> function, append <code>?buy=1</code> to <code>/auth/google?redirectUrl=${redirectUrl}</code> so that it becomes:</p>
<pre>/auth/google?redirectUrl=${redirectUrl}?buy=1</pre>

<p>Next, make changes to the <code>ReadChapter</code> page component so it passes <code>showModal</code> to the <code>BuyButton</code> component:</p>
<ol>
<li><p>Update the <code>&lt;BuyButton&gt;</code> component by passing this extra prop:</p>
<pre>BuyButton user={user} book={book} showModal={showStripeModal}</pre>

<p>Inside <code>renderMainContent</code>, define <code>showStripeModal</code> as <code>this.props.showStripeModal</code> with ES6 destructuring:</p>
<pre>const { user, showStripeModal } = this.props;</pre></li>
<li><p>Add <code>showStripeModal</code> to <code>static PropTypes</code>:<br><code>showStripeModal: PropTypes.bool.isRequired</code></p>
</li>
<li><p>Finally, write code that makes <code>showStripeModal</code> detect the <code>buy=1</code> query in the URL:</p>
<pre>const showStripeModal = req ? !!req.query.buy : window.location.search.includes('buy=1');</pre>

<p>This code above says that, when <code>req</code> exists, <code>showStripeModal</code> is true when the query <code>?buy=</code> exists (<code>req.query.buy</code> exists thus <code>!!req.query.buy</code> is true). When <code>req</code> does not exist, then <code>showStripeModal</code> is true when <code>window.location.search.includes('buy=1')</code> exists. <a target="_blank" href="https://www.w3schools.com/jsref/prop_loc_search.asp" rel="noopener noreferrer">location.search</a> returns the query part of the URL - in our case, everything after the first <code>?</code> symbol. For example, for Chapter 1 of our demo book, <code>window.location.search</code>:</p>
<pre>?redirectUrl=/books/demo-book/example?buy=1</pre>

<p>The JavaScript method <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/includes" rel="noopener noreferrer">includes('buy=1')</a> checks if <code>buy=1</code> is included in <code>window.location.search</code>.</p>
<p>We defined <code>showStripeModal</code> with conditional logic because sometimes the page is server-side rendered (<code>req.query.buy</code> is available on the server) and sometimes client-side rendered (<code>window.location.search</code> is available on client).</p>
<p>Add the above definition of <code>showStripeModal</code> inside the <code>getInitialProps()</code> method like this:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title">getInitialProps</span>(<span class="hljs-params">{ req, query }</span>)</span> {
<span class="hljs-keyword">const</span> { bookSlug, chapterSlug } = query;

<span class="hljs-keyword">const</span> headers = {};
<span class="hljs-keyword">if</span> (req &amp;&amp; req.headers &amp;&amp; req.headers.cookie) {
  headers.cookie = req.headers.cookie;
}

<span class="hljs-keyword">const</span> chapter = <span class="hljs-keyword">await</span> getChapterDetail({ bookSlug, chapterSlug }, { headers });

<span class="hljs-keyword">const</span> showStripeModal = req ? !!req.query.buy : window.location.search.includes(<span class="hljs-string">'buy=1'</span>);

<span class="hljs-keyword">return</span> { chapter, showStripeModal };
}</code></pre></li>
</ol>
<p>Our code is ready for testing.</p>
<p>While logged out, navigate to: <code>http://localhost:8000/books/demo-book/example</code><br>Click on the blue <code>Buy book</code> button. Log in as a Customer (non-Admin) user.<br>You will be automatically redirected back to Chapter 1:<br><code>http://localhost:8000/books/demo-book/example?buy=1</code><br>This time you will the Stripe modal and there is no need for you to click <code>Buy book</code> again:<br><img src="https://user-images.githubusercontent.com/10218864/36957272-1c36e9e0-1fe8-11e8-8b61-5a95f63bd037.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
</li>
</ol>
<p>We are done with UX improvements to our checkout flow. In the next section, we will work on the <code>MyBooks</code> page. Our main goal is to display a hyperlinked title for the book purchased by a Customer user.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="mybooks-page" href="#mybooks-page" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="mybooks-page">
          MyBooks page
        </span>
      </h2><p>The <code>MyBooks</code> page is a Customer page, and it contains a list of books purchased by a user. Think of it as the Customer's dashboard. </p>
<p>Before we start writing code for any new page, the first step is to decide how to render that page - server-side or client-side.</p>
<p>For example, the <code>Admin</code> page (<code>pages/admin/index.js</code>) is client-side rendered, and the <code>getBookList()</code> API method is called inside the <code>componentDidMount()</code> lifecycle hook. If you load the <code>/admin</code> page, you will notice that the page loads <em>without</em> data (without the list of books). Data appears with a small but noticable delay. If Admin UX is our priority, we would display some kind of loading UI while the Admin user waits for data to appear. For example, we could've displayed Nprogress, a spinner, or simply text <code>loading...</code>.</p>
<p>In comparison, the <code>ReadChapter</code> page is server-side rendered (on initial load), and the <code>getChapterDetail()</code> API method is called inside the <code>getInitialProps()</code> method instead of <code>componentDidMount()</code>. The UX advantage of a server-side rendered page is that it does not require loading UI. The page loads <em>with</em> data, never without data.</p>
<p>Admin UX is not our first priority - Customer UX is. Thus, we will implement the <code>MyBook</code> page so that it is server-side rendered on initial load. We will place the API method <code>getMyBookList()</code> inside the <code>getInitialProps()</code> method.</p>
<p>You created multiple page at this point. The most recent server-side rendered page was the <code>ReadChapter</code> page. Take a look at the <code>getInitialProps()</code> method at <code>pages/public/read-chapter.js</code>:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title">getInitialProps</span>(<span class="hljs-params">{ req, query }</span>)</span> {
  <span class="hljs-keyword">const</span> { bookSlug, chapterSlug } = query;

  <span class="hljs-keyword">const</span> headers = {};
  <span class="hljs-keyword">if</span> (req &amp;&amp; req.headers &amp;&amp; req.headers.cookie) {
    headers.cookie = req.headers.cookie;
  }

  <span class="hljs-keyword">const</span> chapter = <span class="hljs-keyword">await</span> getChapterDetail({ bookSlug, chapterSlug }, { headers });
  <span class="hljs-keyword">const</span> showStripeModal = req ? !!req.query.buy : window.location.search.includes(<span class="hljs-string">'buy=1'</span>);

  <span class="hljs-keyword">return</span> { chapter, showStripeModal };
}</code></pre><p>One similarity between the <code>MyBooks</code> and <code>ReadChapter</code> pages is that we will pass a <code>cookie</code> as <code>headers.cookie</code> to the server. If we don't do this, then <code>req.user</code> won't be available on the server. (You remember from Chapter 3 that cookie has encoded session id, session has user id, and with this user id, the server can find a user and create <code>req.user</code> that is used in many Express routes to check user permissions or to update user parameters.)</p>
<p>The difference between these pages is that <code>ReadChapter</code> shows <code>chapter.htmlExcerpt</code> to a logged-out user, but <code>MyBooks</code> should not be available at all to a logged-out user. Good UX would be to redirect the logged-out user, who stumbled upon the <code>/my-books</code> route, to the <code>Login</code> page:</p>
<pre><code><span class="hljs-meta">if</span> (req <span class="hljs-variable">&amp;&amp;</span> !req.user) {
  res.<span class="hljs-meta">redirect</span>(<span class="hljs-string">'/login'</span>);
  <span class="hljs-meta">return</span> { purchasedBooks: [] };
}</code></pre><p>If a user is logged in, then we define and return an array of purchased books <code>purchasedBooks</code> like this:</p>
<pre><code><span class="hljs-section">const</span> { <span class="hljs-attribute">purchasedBooks</span> } = await getMyBookList({ <span class="hljs-attribute">headers</span> });
<span class="hljs-section">return</span> { <span class="hljs-attribute">purchasedBooks</span> };</code></pre><p>Summarize the above description of the <code>getInitialProps()</code> method:</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title">getInitialProps</span>(<span class="hljs-params">{ req, res }</span>)</span> {
  <span class="hljs-keyword">if</span> (req &amp;&amp; !req.user) {
    res.redirect(<span class="hljs-string">'/login'</span>);
    <span class="hljs-keyword">return</span> { purchasedBooks: [] };
  }

  <span class="hljs-keyword">const</span> headers = {};
  <span class="hljs-keyword">if</span> (req &amp;&amp; req.headers &amp;&amp; req.headers.cookie) {
    headers.cookie = req.headers.cookie;
  }

  <span class="hljs-keyword">const</span> { purchasedBooks } = <span class="hljs-keyword">await</span> getMyBookList({ headers });
  <span class="hljs-keyword">return</span> { purchasedBooks };
}</code></pre><p>Remember how you rendered a list of sections using the <code>map()</code> JavaScript method. Open <code>pages/public/read-chapter.js</code> and find the <code>renderSections()</code> function:</p>
<pre><code>renderSections() {
  <span class="hljs-keyword">const</span> { sections } = <span class="hljs-keyword">this</span>.state.chapter;
  <span class="hljs-keyword">const</span> { activeSection } = <span class="hljs-keyword">this</span>.state;

  <span class="hljs-keyword">if</span> (!sections || !sections.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {sections.map(s =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{s.escapedText}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">paddingTop:</span> '<span class="hljs-attr">10px</span>' }}&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">color:</span> <span class="hljs-attr">activeSection</span> &amp;&amp; <span class="hljs-attr">activeSection.hash</span> === <span class="hljs-string">s.escapedText</span> ? '#<span class="hljs-attr">1565C0</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">222</span>',
            }}
            <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`#${<span class="hljs-attr">s.escapedText</span>}`}
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.closeTocWhenMobile}</span>
          &gt;</span>
            {s.text}
          <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}</code></pre><p>Let's use this example above for <code>purchasedBooks</code>:</p>
<pre><code>{purchasedBooks &amp;&amp; purchasedBooks.length &gt; 0 ? (
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Your books<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {purchasedBooks.map(book =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{book._id}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
            <span class="hljs-attr">as</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">books</span>/${<span class="hljs-attr">book.slug</span>}/<span class="hljs-attr">introduction</span>`}
            <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">public</span>/<span class="hljs-attr">read-chapter</span>?<span class="hljs-attr">bookSlug</span>=<span class="hljs-string">${book.slug}&amp;chapterSlug</span>=<span class="hljs-string">introduction</span>`}
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>{book.name}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
) : (
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Your books<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You have not purchased any book.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
)}</code></pre><p>That's it, the page is pretty much done. Go to your <code>pages/customer/my-books</code> file and put together the <code>getInitialProps()</code> and <code>render()</code> methods. Inside <code>render()</code>, remember to define <code>purchasedBooks</code> with:</p>
<pre>const { purchasedBooks } = this.props;</pre>

<p>Add missing imports, propTypes, defaultProps, and <code>&lt;Head&gt;</code> with <code>&lt;title&gt;</code>. Wrap the page component with <code>withAuth</code> HOC. Export with <code>export default withAuth(MyBooks);</code>:<br><code>pages/customer/my-books.js</code> :</p>
<pre><code><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>;
<span class="hljs-keyword">import</span> Link <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;
<span class="hljs-keyword">import</span> Head <span class="hljs-keyword">from</span> <span class="hljs-string">'next/head'</span>;

<span class="hljs-keyword">import</span> { getMyBookList } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/api/customer'</span>;
<span class="hljs-keyword">import</span> withAuth <span class="hljs-keyword">from</span> <span class="hljs-string">'../../lib/withAuth'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBooks</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  <span class="hljs-keyword">static</span> propTypes = {
    <span class="hljs-attr">purchasedBooks</span>: PropTypes.arrayOf(PropTypes.shape({
      <span class="hljs-attr">name</span>: PropTypes.string.isRequired,
    })),
  };
  <span class="hljs-keyword">static</span> defaultProps = {
    <span class="hljs-attr">purchasedBooks</span>: [],
  };

  <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> getInitialProps({ req, res }) {
    <span class="hljs-keyword">if</span> (req &amp;&amp; !req.user) {
      res.redirect(<span class="hljs-string">'/login'</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">purchasedBooks</span>: [] };
    }

    <span class="hljs-keyword">const</span> headers = {};
    <span class="hljs-keyword">if</span> (req &amp;&amp; req.headers &amp;&amp; req.headers.cookie) {
      headers.cookie = req.headers.cookie;
    }

    <span class="hljs-keyword">const</span> { purchasedBooks } = <span class="hljs-keyword">await</span> getMyBookList({ headers });
    <span class="hljs-keyword">return</span> { purchasedBooks };
  }

  render() {
    <span class="hljs-keyword">const</span> { purchasedBooks } = <span class="hljs-keyword">this</span>.props;

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Head</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>My Books<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">10px</span> <span class="hljs-attr">45px</span>' }}&gt;</span>
          {purchasedBooks &amp;&amp; purchasedBooks.length &gt; 0 ? (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Your books<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                {purchasedBooks.map(book =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{book._id}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
                      <span class="hljs-attr">as</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">books</span>/${<span class="hljs-attr">book.slug</span>}/<span class="hljs-attr">introduction</span>`}
                      <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">public</span>/<span class="hljs-attr">read-chapter</span>?<span class="hljs-attr">bookSlug</span>=<span class="hljs-string">${book.slug}&amp;chapterSlug</span>=<span class="hljs-string">introduction</span>`}
                    &gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>{book.name}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                ))}
              <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ) : (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Your books<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>You have not purchased any book.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> withAuth(MyBooks);</code></pre><p>This page won't get any data yet, since we did not define the <code>getMyBookList</code> API method and did not write an Express route nor static method for <code>getMyBookList</code> in our Book model.</p>
<h4 style="color: #FFF;">
        <a name="api-method-getmybooklist" href="#api-method-getmybooklist" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        API method getMyBookList
      </h4><p>Since we pass <code>headers</code> to <code>getMyBookList</code>, we should take a look at the <code>getChapterDetails</code> API method that accepts <code>headers</code> as well. Open <code>lib/api/public.js</code>:</p>
<pre><code><span class="hljs-string">export </span><span class="hljs-string">const </span><span class="hljs-string">getChapterDetail </span>= ({ <span class="hljs-string">bookSlug,</span> <span class="hljs-string">chapterSlug </span>}, <span class="hljs-string">options </span>= {}) =&gt;
  <span class="hljs-string">sendRequest(</span>
    `${<span class="hljs-string">BASE_PATH}</span>/<span class="hljs-built_in">get-chapter-detail?bookSlug=${bookSlug}&amp;chapterSlug=${chapterSlug}`,</span>
    <span class="hljs-string">Object.</span><span class="hljs-string">assign(</span>
      {
        <span class="hljs-string">method:</span> <span class="hljs-string">'GET'</span>,
      },
      <span class="hljs-string">options,</span>
    ),
  );</code></pre><p>Re-write the above API method. Keep in mind that we pass <code>headers</code> as <code>options.headers</code>, and the non-base part of API endpoint is <code>/my-books</code>:<br><code>lib/api/customer.js</code> :</p>
<pre><code><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getMyBookList = <span class="hljs-function">(<span class="hljs-params">options = {}</span>) =&gt;</span>
  sendRequest(
    <span class="hljs-string">`<span class="hljs-subst">${BASE_PATH}</span>/my-books`</span>,
    <span class="hljs-built_in">Object</span>.assign(
      {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
      },
      options,
    ),
  );</code></pre><h4 style="color: #FFF;">
        <a name="express-route-39-my-books-39-" href="#express-route-39-my-books-39-" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Express route '/my-books'
      </h4><p>Our next step is to write an Express route with the method <code>GET</code> and route <code>/my-books</code>. At this point, you know that a function inside <code>/my-books</code> Express route should call and wait for static method and then return <code>purchasedBooks</code>. Let's make the static method <code>Book.getPurchasedBooks()</code> return <code>purchasedBooks</code>:</p>
<pre>const { purchasedBooks } = await Book.getPurchasedBooks({ purchasedBookIds });</pre>

<p>The above static method requires ids of books that are purchased by a user. Where do we get these ids? Since we did pass a cookie to the server, then <code>req.user</code> exists. We can look into <code>req.user.purchaseBookIds</code> for ids of books purchased by a user. This means that we need to modify our <code>Book.buy()</code> static method so that the user document of a user who buys a book gets <code>purchaseBookIds</code> array as a parameter.</p>
<p>Open <code>server/models/User.js</code> and make 2 small changes to the file:</p>
<ul>
<li>add <code>purchasedBookIds: [String]</code> to mongoSchema,</li>
<li>add <code>'purchasedBookIds'</code> to <code>static publicFields()</code></li>
</ul>
<p>Open <code>server/models/Book.js</code>. Add a line of code that <em>finds and updates</em> a user who bought a book. Use the Mongoose method <code>findByIdAndUpdate()</code>:</p>
<pre>User.findByIdAndUpdate(user.id, { $addToSet: { purchasedBookIds: book.id } }).exec();</pre>

<p>Add the above line of code right before the line with <code>const template = await getEmailTemplate()</code> inside the static method <code>buy()</code>.<br>Remember to import <code>User</code> to <code>server/models/Book.js</code>. Eslint should tell you if an import is missing.</p>
<p>Back to the Express route.</p>
<p>Let's define <code>purchasedBooksIds</code> with ES6 object destructuring:</p>
<pre>const { purchasedBookIds = [] } = req.user;</pre>

<p>We are ready to put our Express route together. As always, we suggest using <code>try/catch</code> with <code>async/await</code>:<br><code>server/api/customer.js</code> :</p>
<pre><code>router.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/my-books'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { purchasedBookIds = [] } = req.user;

    <span class="hljs-keyword">const</span> { purchasedBooks } = <span class="hljs-keyword">await</span> Book.getPurchasedBooks({ purchasedBookIds });

    res.json({ purchasedBooks });
  } <span class="hljs-keyword">catch</span> (err) {
    res.json({ error: err.message || err.toString() });
  }
});</code></pre><p>The only missing part in our client-server data exchange is the static method <code>getPurchasedBooks()</code>.</p>
<h4 style="color: #FFF;">
        <a name="static-method-book-getpurchasedbooks-" href="#static-method-book-getpurchasedbooks-" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Static method Book.getPurchasedBooks()
      </h4><p>In the previous section, we wrote code that saves a purchased book id to a user document.<br>Start your app. Make sure you use a Customer user who did not buy <code>demo-book</code>. If necessary, go to your <code>test.purchases</code> collection at MongoDB Atlas and delete the Purchase document for your Customer user who bought <code>demo-book</code>. Now buy a book and go to your <code>test.users</code> collection at MongoDB Atlas, <code>test</code> database. Open the user document and you will see a new array:</p>
<pre><code><span class="hljs-string">"purchasedBookIds"</span>: [
    <span class="hljs-string">"5a90d1c1b0466e2eee5f8508"</span>
]</code></pre><p>The static method <code>getPurchasedBooks()</code> finds all books in the books collection using the <code>purchasedBookIds</code> array, and the method returns <code>purchasedBooks</code> to the Express route <code>/my-books</code>. We will use the <code>find()</code> and <code>sort()</code> Mongoose methods that you know well by this point:<br><code>server/models/Book.js</code> :</p>
<pre><code><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title">getPurchasedBooks</span>(<span class="hljs-params">{ purchasedBookIds }</span>)</span> {
  <span class="hljs-keyword">const</span> purchasedBooks = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.find({ _id: { $<span class="hljs-keyword">in</span>: purchasedBookIds } }).sort({
    createdAt: <span class="hljs-number">-1</span>,
  });
  <span class="hljs-keyword">return</span> { purchasedBooks };
}</code></pre><p>You may not be familiar with the <code>{ $in: [array] }</code> operator. <a target="_blank" href="https://docs.mongodb.com/manual/reference/operator/query/in/#op._S_in" rel="noopener noreferrer">$in</a> allows us to find all documents with a <code>field</code> value matching one of the values inside an array:</p>
<pre>{ field: { $in: [<value1>, <value2>, ... <valuen> ] } }</valuen></value2></value1></pre>

<p>Start your app, log in, and navigate to <code>http://localhost:8000/my-books</code>:<br><img src="https://user-images.githubusercontent.com/10218864/37013260-d727d2f8-20ad-11e8-800b-80dd8a0c4d26.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Ta-da, you now see a list of purchased books.</p>
<p>In the next section, we discuss how to add user emails to a Mailchimp list. In the section after that, you will learn how to prepare your app for production and deploy it.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="mailchimp-api" href="#mailchimp-api" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="mailchimp-api">
          Mailchimp API
        </span>
      </h2><p>In this section, our goal is to modify the static method <code>Book.buy()</code>, which we wrote earlier in this chapter, so that the email of a user who purchases a book gets added to a Mailchimp list.</p>
<p>After publishing and selling a book, you may occasionally need to send announcements to everyone who bought the book. For example, you may add a new chapter or make a major update to the book. We'll set up an API so that you can email people who bought a book by using a Mailchimp list.</p>
<p>Open <code>server/models/Book.js</code> and find the static method <code>buy()</code>. Find this line of code that creates a new Purchase document:</p>
<pre>return Purchase.create()</pre>

<p>Before this line, add a <code>try/catch</code> construct that calls and waits for the <code>subscribe()</code> method (which we will define at <code>server/mailchimp.js</code>):</p>
<pre><code><span class="hljs-keyword">try</span> {
  <span class="hljs-function">await <span class="hljs-title">subscribe</span><span class="hljs-params">({ email: user.email })</span></span>;
} <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">error</span>) {
  logger.<span class="hljs-keyword">error</span>(<span class="hljs-string">'Mailchimp error:'</span>, <span class="hljs-keyword">error</span>);
}</code></pre><p>The <code>subscribe()</code> method will take a user's email and add it to a Mailchimp list. The list name is not the actual name of the list on your Mailchimp dashboard but the name of the variable that points to a unique <code>List ID</code>. More on this below.</p>
<p>Inside the <code>subscribe()</code> method, our goal is to send a POST request from our server to a Mailchimp server.</p>
<p>In this book, you wrote code related to third party APIs for Google OAuth, Github, AWS SES,and  Stripe. If you remember, for Google OAuth, AWS SES, Stripe - we <em>did not</em> write any code related to an actual <em>request</em> (request from our server to a third party server). We used packages to send requests (usually, GET and/or POST) from our server to third party platform services. We wrote request-related code only in one instance - building Github integration.</p>
<p>Go ahead and open <code>server/github.js</code> and find the code for request:</p>
<pre><code><span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.post</span>(
  {
    <span class="hljs-attribute">url</span>: TOKEN_URI,
    <span class="hljs-attribute">headers</span>: { <span class="hljs-attribute">Accept</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attribute">form</span>: {
      <span class="hljs-attribute">client_id</span>: CLIENT_ID,
      code,
      <span class="hljs-attribute">client_secret</span>: API_KEY,
    },
  },
  async (err, response, body) =&gt; {
    <span class="hljs-comment">// code that manages error</span>
    <span class="hljs-comment">// code that manages success</span>
  },
);</code></pre><p>This request is sent via POST (<code>request.post</code>) to Github's server when an Admin user authorizes our app to access data on his/her Github account. You see that we pass <code>CLIENT_ID</code> and <code>API_KEY</code> of our app to Github's server with <code>form</code>. For Mailchimp, we will pass the API key with <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization" rel="noopener noreferrer">Authorization header</a> (<code>headers.Authorization</code>). Syntax for Authorization header: <code>Authorization: &lt;type&gt; &lt;credentials&gt;</code></p>
<p>In our case:</p>
<pre>Authorization: Basic apikey:API_KEY</pre>

<p>The <code>API_KEY</code> must be base64 encoded. Recall how we did base64 decoding for <code>chapter.data.content</code> in <a target="_blank" href="https://builderbook.org/books/builder-book/github-integration-admin-dashboard-testing-admin-ux-and-github-integration#synccontent-for-book-model" rel="noopener noreferrer">Chapter 6</a>.</p>
<p>After encoding:</p>
<pre>Authorization: `Basic ${Buffer.from(`apikey:${API_KEY}`).toString('base64')}`</pre>


<p>Accept header in a Mailchimp request is the same as in a Github request. Follow the above example of a request to Github to put together a request to Mailchimp:</p>
<pre><code>request.post(
  {
    <span class="hljs-attr">uri</span>: <span class="hljs-string">`<span class="hljs-subst">${ROOT_URI}</span><span class="hljs-subst">${path}</span>`</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">Accept</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Basic <span class="hljs-subst">${<span class="hljs-built_in">Buffer</span>.from(<span class="hljs-string">`apikey:<span class="hljs-subst">${API_KEY}</span>`</span>).toString(<span class="hljs-string">'base64'</span>)}</span>`</span>,
    },
    <span class="hljs-attr">json</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">body</span>: data,
  },
  (err, response, body) =&gt; {
    <span class="hljs-keyword">if</span> (err) {
      reject(err);
    } <span class="hljs-keyword">else</span> {
      resolve(body);
    }
  },
);</code></pre><p>We used the variables <code>ROOT_URI</code> and <code>API_KEY</code>.</p>
<p><code>ROOT_URI</code> is the Mailchimp API endpoint to which our app sends a request. In general, it is:</p>
<pre>https://usX.api.mailchimp.com/3.0/lists/{list_id}/members</pre>

<p>Read more about the <a target="_blank" href="http://developer.mailchimp.com/documentation/mailchimp/reference/lists/members/" rel="noopener noreferrer">API to add members to a list</a>.</p>
<p>Region <code>usX</code> is a subdomain. Follow these steps to find the subdomain for an API endpoint:</p>
<ul>
<li>sign up or log in to Mailchimp</li>
<li>go to <code>Account &gt; Extras &gt; API keys &gt; Your API keys</code></li>
<li>your API key will look like <code>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-us17</code></li>
</ul>
<p>That means the region is <code>us17</code> and your app will send requests to the Mailchimp subdomain:</p>
<pre>https://us17.api.mailchimp.com/3.0/lists/{list_id}/members</pre>


<p>Let's add the <code>LIST_IDS</code> variable to request uri:</p>
<pre>https://us17.api.mailchimp.com/3.0/lists/${LIST_IDS}/members/</pre>


<p>We can add an actual value, but let's add the variable in case we decide to save emails to a different list at some point. We define <code>LIST_IDS</code> as:</p>
<pre><code><span class="hljs-keyword">const</span> LIST_IDS =  <span class="hljs-built_in">process</span>.env.MAILCHIMP_PURCHASED_LIST_ID;</code></pre><p>And we define <code>API_KEY</code> as:</p>
<pre>const API_KEY = process.env.MAILCHIMP_API_KEY;</pre>

<p>This is a good place to add <code>MAILCHIMP_PURCHASED_LIST_ID</code> and <code>MAILCHIMP_API_KEY</code> to your <code>.env</code> file. We discussed how to find the <code>API_KEY</code> above, it looks like: ``xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-us17`.</p>
<p>To find <code>List ID</code>, follow these steps:</p>
<ul>
<li>on your Mailchimp dashboard, go to <code>Lists &gt; click the list name &gt; Settings &gt; List name and defaults</code></li>
<li>find the section <code>List ID</code></li>
<li>get the <code>xxxxxxxxxx</code> value from this section</li>
</ul>
<p>Now we are ready to put together the <code>subscribe()</code> method that sends POST request to Mailchimp server. Follow these steps:</p>
<ul>
<li>Create <code>server/mailchimp.js</code> file.</li>
<li>Import <code>request</code></li>
<li>Add <code>require('dotenv').config();</code> since access env variables with <code>process.env</code>.</li>
<li>Save <code>parameter</code> email to <code>data.email_address</code>. Set <code>data.status</code> to <code>subscribed</code> (we pass <code>data</code> to request's <code>body</code>).</li>
</ul>
<p>You will get:<br><code>server/mailchimp.js</code> :</p>
<pre><code><span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);

<span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).config();

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subscribe</span>(<span class="hljs-params">{ email }</span>) </span>{
  <span class="hljs-keyword">const</span> data = {
    <span class="hljs-attr">email_address</span>: email,
    <span class="hljs-attr">status</span>: <span class="hljs-string">'subscribed'</span>,
  };

  <span class="hljs-keyword">const</span> LIST_IDS = process.env.MAILCHIMP_PURCHASED_LIST_ID;

  <span class="hljs-keyword">const</span> API_KEY = process.env.MAILCHIMP_API_KEY;

  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    request.post(
      {
        <span class="hljs-attr">uri</span>: <span class="hljs-string">`https://us17.api.mailchimp.com/3.0/lists/<span class="hljs-subst">${LIST_IDS}</span>/members/`</span>,
        <span class="hljs-attr">headers</span>: {
          <span class="hljs-attr">Accept</span>: <span class="hljs-string">'application/json'</span>,
          <span class="hljs-attr">Authorization</span>: <span class="hljs-string">`Basic <span class="hljs-subst">${Buffer.<span class="hljs-keyword">from</span>(<span class="hljs-string">`apikey:<span class="hljs-subst">${API_KEY}</span>`</span>).toString(<span class="hljs-string">'base64'</span>)}</span>`</span>,
        },
        <span class="hljs-attr">json</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">body</span>: data,
      },
      (err, response, body) =&gt; {
        <span class="hljs-keyword">if</span> (err) {
          reject(err);
        } <span class="hljs-keyword">else</span> {
          resolve(body);
        }
      },
    );
  });
}

exports.subscribe = subscribe;</code></pre><p>Done!</p>
<p>In above construct we used <code>async/await</code> as well as <code>new Promise()</code>. You may remember from <a target="_blank" href="https://builderbook.org/books/builder-book/authentication-hoc-promise-async-await-static-method-for-user-model-google-oauth#async-await" rel="noopener noreferrer">Chapter 3, section Async/await</a> that function after <code>await</code> must return a Promise.</p>
<p>Time to test. Make sure that the actual values of <code>MAILCHIMP_PURCHASED_LIST_ID</code> and <code>MAILCHIMP_API_KEY</code> are in your <code>.env</code> file.</p>
<p>To test the <code>subscribe()</code> method, we need to run the static method <code>buy()</code> from our Book model. This means you have to buy a book. When testing, make sure you login with a Customer user who <em>has not bought a book</em>. In case your Customer user <em>bought a book</em>, here's how to un-buy a book:</p>
<ul>
<li>on your database, delete the user's corresponding Purchase document from the purchases collection</li>
<li>find the user document for your User (users collection) and delete the parameter <code>purchasedBookIds</code>.</li>
</ul>
<p>Go to your Mailchimp dashboard and access <code>Lists &gt; click on list name</code>. Notice that the list is empty:<br><img src="https://user-images.githubusercontent.com/10218864/37052749-08b1c424-212f-11e8-89db-e7338cbc6582.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Start your app and go to <code>http://localhost:8000/books/demo-book/example</code>. Click the <code>Buy book</code> button and go through the checkout.</p>
<p>After successfully purchasing the book, refresh the page on Mailchimp. You will see a new subscriber:<br><img src="https://user-images.githubusercontent.com/10218864/37053390-def0baee-2130-11e8-88cd-959f39519cf8.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Nice! Now you have a communication method with people who bought your book. Use it wisely, never spam.</p>
<p>For deeper dive into Mailchimp integration, check our <a target="_blank" href="https://medium.freecodecamp.org/how-to-integrate-mailchimp-in-a-javascript-web-app-2a889fb43f6f" rel="noopener noreferrer">our tutorial</a> at freeCodeCamp. In this tutorial, we did extensive testing of Mailchimp integration with <a target="_blank" href="https://www.getpostman.com" rel="noopener noreferrer">Postman</a> and <a target="_blank" href="https://developers.google.com/web/tools/chrome-devtools/console" rel="noopener noreferrer">browser console</a>.</p>
<p>In the next and final section of our book, we will prepare our app for production and deploy it.</p>
<h2 class="chapter-section" style="color: #FFF; font-weight: 400;">
        <a name="deploy-app" href="#deploy-app" style="color: #FFF;"> 
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
            link
          </i>
        </a>
        <span class="section-anchor" name="deploy-app">
          Deploy app
        </span>
      </h2><p>So far we've been running our app locally at <code>http://localhost:8000</code>. However to deploy our app, we need to:</p>
<ul>
<li>set the root URL to <code>https://builderbook.org</code> instead of <code>http://localhost:8000</code></li>
<li>set <code>NODE_ENV</code> to production</li>
<li>when <code>NODE_ENV</code> is in production, tell our app to use production (i.e. live) API keys instead of development (i.e. test) keys.</li>
</ul>
<p>Once we prepare our app for production, we will deploy it with <a target="_blank" href="https://zeit.co/about" rel="noopener noreferrer">Now</a> and optimize the app for search engines.</p>
<h4 style="color: #FFF;">
        <a name="node_env-root_url-mongo_url" href="#node_env-root_url-mongo_url" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        NODE_ENV, ROOT_URL, MONGO_URL
      </h4><p>Throughout our app, we defined <code>dev</code> with this line of code:</p>
<pre>const dev = process.env.NODE_ENV !== 'production';</pre>

<p>Most recently, we wrote this line at <code>env-config.js</code>. Find this line of code in <code>server/app.js</code>, <code>server/stripe.js</code>, and <code>server/github.js</code> as well.</p>
<p>This code says that <code>dev</code> is true when <code>NODE_ENV</code> is not <code>production</code>. Open <code>server/app.js</code> and find this snippet:</p>
<pre><code><span class="hljs-keyword">const</span> dev = <span class="hljs-built_in">process</span>.env.NODE_ENV !== <span class="hljs-string">'production'</span>;
<span class="hljs-keyword">const</span> MONGO_URL = <span class="hljs-built_in">process</span>.env.MONGO_URL_TEST;

<span class="hljs-keyword">const</span> options = {
  useNewUrlParser: true,
  useCreateIndex: true,
  useFindAndModify: false,
};
mongoose.<span class="hljs-built_in">connect</span>(
  MONGO_URL,
  options,
);

<span class="hljs-keyword">const</span> port = <span class="hljs-built_in">process</span>.env.PORT || <span class="hljs-number">8000</span>;
<span class="hljs-keyword">const</span> ROOT_URL = `http:<span class="hljs-comment">//localhost:${port}`;</span></code></pre><p>Add the following three <code>console.log()</code> statements right after the code snippet above:</p>
<pre><code><span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">process</span><span class="hljs-selector-class">.env</span><span class="hljs-selector-class">.NODE_ENV</span>);
<span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">dev</span>);
<span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">ROOT_URL</span>);</code></pre><p>Start your app with <code>yarn dev</code> and pay attention to the terminal output:</p>
<pre><code><span class="hljs-literal">undefined</span>
<span class="hljs-literal">true</span>
http:<span class="hljs-comment">//localhost:8000</span></code></pre><p>So <code>dev</code> is true because <code>process.env.NODE_ENV</code> is undefined (we did not set it!), and <code>ROOT_URL</code> is <code>http://localhost:8000</code>.</p>
<p>Our goal is to set <code>process.env.NODE_ENV</code> and once it is set, use it to specify a <em>production-specific</em> <code>ROOT_URL</code> and other environmental variables, such as API keys.</p>
<p>Open <code>package.json</code> and find the <code>scripts</code> block.<br>Prepend <code>NODE_ENV=production</code> to the <code>dev</code> command, so it becomes:</p>
<pre>"dev": "NODE_ENV=production nodemon server/app.js --watch server",</pre>

<p>Start your app with <code>yarn dev</code> and now the terminal prints:</p>
<pre><code>production
<span class="hljs-literal">false</span>
http:<span class="hljs-comment">//localhost:8000</span>
&gt; Could <span class="hljs-built_in">not</span> <span class="hljs-built_in">find</span> a valid build <span class="hljs-built_in">in</span> the <span class="hljs-string">'.next'</span> directory! <span class="hljs-keyword">Try</span> building your app <span class="hljs-keyword">with</span> <span class="hljs-string">'next build'</span> before starting the server.
[nodemon] app crashed - waiting <span class="hljs-keyword">for</span> file changes before starting...</code></pre><p>Alright, not bad!  You successfully set the environment to <code>production</code>.</p>
<p>Next.js tells us that we need to build our app with <code>NODE_ENV=production</code> before we run it. In the <code>scripts</code> of <code>package.json</code>, modify the <code>build</code> command like this:</p>
<pre>"build": "NODE_ENV=production next build",</pre>

<p>Run <code>yarn build</code>. When complete, start your app with <code>yarn dev</code>. Now the app runs locally but with <code>NODE_ENV=production</code>. You'll notice that the <code>ROOT_URL</code> is still <code>http://localhost:8000</code>. Let's change that by writing a conditional construct. Replace this line inside <code>server/app.js</code>:</p>
<pre>const ROOT_URL = `http://localhost:${port}`;</pre>

<p>with:</p>
<pre>const ROOT_URL = dev ? `http://localhost:${port}` : 'https://builderbook.org';</pre>

<p>Now run <code>yarn build</code> and <code>yarn dev</code>. The terminal outputs:</p>
<pre><code>production
<span class="hljs-literal">false</span>
<span class="hljs-string">https:</span><span class="hljs-comment">//builderbook.org</span></code></pre><p>Try logging in - you'll see that it will fail. This makes sense because we <em>did not</em> add routes from <code>server/google.js</code>, <code>https://builderbook.org/auth/google</code>, and <code>https://builderbook.org/oauth2callback</code>, to our Google OAuth app on Google Cloud Platform. We only added development-related routes <code>http://localhost:8000/auth/google</code> and <code>http://localhost:8000/oauth2callback</code>.</p>
<p>We added Express routes <code>/auth/google</code> and <code>/oauth2callback</code> to our server with:</p>
<pre>auth({ server, ROOT_URL });</pre>

<p>Thus we took care of <code>ROOT_URL</code> for Google OAuth.</p>
<p>However, the <code>sendRequest()</code> function inside <code>lib/api/sendRequest.js</code> also uses <code>ROOT_URL</code>, and all API methods in our app use the <code>sendRequest()</code> function to send a request (<code>GET</code> or <code>POST</code>) from client to server. Open <code>lib/api/sendRequest.js</code> and find this snippet:</p>
<pre><code><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(
  <span class="hljs-string">`<span class="hljs-subst">${ROOT_URL}</span><span class="hljs-subst">${path}</span>`</span>,
  <span class="hljs-built_in">Object</span>.assign({ <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, <span class="hljs-attr">credentials</span>: <span class="hljs-string">'same-origin'</span> }, options, { headers }),
);</code></pre><p>We suggest, for the sake of reusability, creating a <code>getRootUrl()</code> function that contains conditional logic and outputs the proper <code>ROOT_URL</code> depending on <code>NODE_ENV</code>. Create a new file <code>lib/api/getRootUrl.js</code> with the following content:</p>
<pre><code><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRootURL</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> port = process.env.PORT || <span class="hljs-number">8000</span>;
  <span class="hljs-keyword">const</span> dev = process.env.NODE_ENV !== <span class="hljs-string">'production'</span>;
  <span class="hljs-keyword">const</span> ROOT_URL = dev ? <span class="hljs-string">`http://localhost:<span class="hljs-subst">${port}</span>`</span> : <span class="hljs-string">'https://builderbook.org'</span>;

  <span class="hljs-keyword">return</span> ROOT_URL;
}</code></pre><p>To use <code>getRootUrl</code> in <code>lib/api/sendRequest.js</code>, follow these steps:</p>
<ul>
<li><p>import <code>getRootUrl</code> with</p>
<pre>import getRootUrl from './getRootUrl';</pre>
</li>
<li><p>update the snippet that contains <code>ROOT_URL</code> like this:</p>
<pre><code><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(
<span class="hljs-string">`<span class="hljs-subst">${getRootUrl()}</span><span class="hljs-subst">${path}</span>`</span>,
<span class="hljs-built_in">Object</span>.assign({ <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>, <span class="hljs-attr">credentials</span>: <span class="hljs-string">'same-origin'</span> }, options, { headers }),
);</code></pre></li>
<li><p>remove unnecessary code:</p>
<pre><code><span class="hljs-keyword">const</span> port = process.env.PORT || <span class="hljs-number">8000</span>;
<span class="hljs-keyword">const</span> ROOT_URL = `http:<span class="hljs-comment">//localhost:${port}`;</span></code></pre></li>
</ul>
<p>Go ahead and use <code>getRootUrl</code> inside <code>server/app.js</code> as well:</p>
<ul>
<li><p>import <code>getRootUrl</code> with</p>
<pre>const getRootUrl = require('../lib/api/getRootUrl');</pre>
</li>
<li><p>update the snippet that contains <code>ROOT_URL</code> by replacing:</p>
<pre>const ROOT_URL = dev ? `http://localhost:${port}` : 'https://builderbook.org';</pre>

<p>with:<br><code>const ROOT_URL = getRootUrl();</code></p>
</li>
<li><p>keep the following line of code, since <code>server.listen()</code> uses <code>port</code>:<br><code>const port = process.env.PORT || 8000;</code></p>
</li>
</ul>
<p>The third and final location where we will use <code>getRootUrl</code> is <code>server/models/Book.js</code>:</p>
<ul>
<li><p>import <code>getRootUrl</code> with</p>
<pre>const getRootUrl = require('../../lib/api/getRootUrl');</pre>
</li>
<li><p>replace this line:</p>
<pre>const ROOT_URL = 'http://localhost:8000';</pre>

<p>with:</p>
<pre>const ROOT_URL = getRootUrl();</pre>


</li>
</ul>
<p>Start your app with <code>yarn dev</code> and look at the terminal:</p>
<pre><code>production
<span class="hljs-literal">false</span>
<span class="hljs-string">https:</span><span class="hljs-comment">//builderbook.org</span></code></pre><p>This output proves that <code>getRootUrl()</code> successfully set the proper value for <code>ROOT_URL</code>.</p>
<p>Please note that whe you deploy app to your own custom domain you should replace <code>https://builderbook.org</code> with your actual domain name. Even better, you can replace <code>https://builderbook.org</code> everywhere in code with <code>process.env.ROOT_URL</code> and then specify <code>ROOT_URL</code> environmental variable with proper value inside <code>.env</code>.</p>
<p>We should make sure that our app uses live API keys instead of test ones. Let's test it out for our Github keys. Open <code>server/github.js</code>. Find the <code>const API_KEY</code> line of code and add <code>console.log()</code> right after it:</p>
<pre><code><span class="hljs-keyword">const</span> API_KEY = dev ? <span class="hljs-built_in">process</span>.env.Github_Test_SecretKey : <span class="hljs-built_in">process</span>.env.Github_Live_SecretKey;
console.log(API_KEY);</code></pre><p>Important note - the Github OAuth app <em>does not</em> support multiple domains. Therefore, you should create a <em>second</em> Github OAuth app and set <code>https://builderbook.org</code> and <code>https://builderbook.org/auth/github/callback</code> for the domain and callback URL. Reminder - in your first Github OAuth app, you set <code>http://localhost:8000</code> and <code>http://localhost:8000/auth/github/callback</code>.</p>
<p>Paste <code>process.env.Github_Live_SecretKey</code> and <code>process.env.Github_Live_ClientID</code> to your <code>.env</code> file.<br>Start your app with <code>yarn dev</code> and you will see that the terminal printed the proper value for <code>API_KEY</code>, which is the value you specified for <code>process.env.Github_Live_SecretKey</code> inside <code>.env</code>.</p>
<p>Before we deploy our app, we need to modify the <code>start</code> command. We stopped using the <code>yarn next</code> command to start our app since <a target="_blank" href="https://builderbook.org/books/builder-book/server-database-session-header-and-menudrop-components#express-server" rel="noopener noreferrer">Chapter 2</a>, where we introduced Express server. When we deploy our app on <code>Now</code>, <code>Now</code> will use the <code>start</code> command to start our app. Thus, we should update it to start our custom Express/Next server. Update it like this:</p>
<pre>"start": "node server/app.js"</pre>

<p>For development, remember to remove <code>NODE_ENV=production</code> from the <code>dev</code> command that we used to run our app locally. The final <code>scripts</code> section inside <code>package.json</code> should be:</p>
<pre><code><span class="hljs-string">"scripts"</span>: {
  <span class="hljs-string">"dev"</span>: <span class="hljs-string">"nodemon server/app.js --watch server"</span>,
  <span class="hljs-string">"build"</span>: <span class="hljs-string">"NODE_ENV=production next build"</span>,
  <span class="hljs-string">"start"</span>: <span class="hljs-string">"node server/app.js"</span>,
  <span class="hljs-string">"lint"</span>: <span class="hljs-string">"eslint components pages lib server"</span>,
  <span class="hljs-string">"test"</span>: <span class="hljs-string">"jest --coverage"</span>
},</code></pre><p>After you are done with testing, remove all the <code>console.log()</code> statements from <code>server/app.js</code> and <code>server/github.js</code>.</p>
<p>We deployed this very site with the following <a target="_blank" href="https://github.com/builderbook/builderbook/blob/master/package.json" rel="noopener noreferrer">scripts</a>. Check it out on Github.</p>
<p>Let's make one more improvement, go to <code>server/app.js</code> and replace:</p>
<pre>const MONGO_URL = process.env.MONGO_URL_TEST;</pre>

<p>With:</p>
<pre>const MONGO_URL = dev ? process.env.MONGO_URL_TEST : process.env.MONGO_URL;</pre>

<p>It is a good idea to use a different databases for production and development. The above change will make our app use environmental variable <code>MONGO_URL</code> instead of <code>MONGO_URL_TEST</code> <b>in production</b>.</p>
<p>In the next subsection, we will discuss best security practices for Express server.</p>
<h4 style="color: #FFF;">
        <a name="security" href="#security" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Security
      </h4><p>Besides setting <code>NODE_ENV</code> and <code>ROOT_URL</code>, we should prepare our server for production from a security point of view. We encourage you to read about the best practices for Express in the <a target="_blank" href="https://expressjs.com/en/advanced/best-practice-security.html" rel="noopener noreferrer">official Express docs</a>.</p>
<p>In this subsection, we will discuss the following security settings:</p>
<ul>
<li>helmet package</li>
<li>trust proxy</li>
<li>cookie.secure</li>
</ul>
<ul>
<li><p>The <a target="_blank" href="https://helmetjs.github.io/" rel="noopener noreferrer">Helmet</a> dependency is a collection of 12 Express middleware functions that set headers to prevent some standard attacks. Read more about each of the 12 middleware functions in the <a target="_blank" href="https://helmetjs.github.io/docs/" rel="noopener noreferrer">Helmet docs</a>. You can use all functions or only one. By default, helmet mounts 7 out 12 middleware functions. One of them is <a target="_blank" href="https://helmetjs.github.io/docs/hide-powered-by" rel="noopener noreferrer">helmet.hidePoweredBy()</a> that simply hides the <code>X-Powered-By</code> header, making it a bit harder to guess which technology you use.</p>
<p>Start your app, go to the <code>MyBooks</code> page, and look at the <code>Response Headers</code>. To do so, open <code>Developer tools &gt; Network &gt; click on my-book.js &gt; select Headers</code>. You will clearly see that our app uses Express since <code>X-Powered-By:Express</code>:<br><img src="https://user-images.githubusercontent.com/10218864/37220585-ec0c0b96-237b-11e8-8c82-f5fba8cfdd1b.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Your app should have the <code>helmet</code> package if you ran <code>yarn</code> at the start of this chapter. To use <code>helmet</code>, add the following line of code right after <code>const server = express();</code>:</p>
<pre>server.use(helmet())</pre>

<p>Check the <code>Response Headers</code> of <code>my-books.js</code>, and this time you won't see <code>X-powered-By</code>:<br><img src="https://user-images.githubusercontent.com/10218864/37220802-8f7dbbd0-237c-11e8-8592-95255dc7cd02.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
</li>
</ul>
<ul>
<li><p>Most hosting platforms scale an app by adding <a target="_blank" href="https://www.nginx.com/resources/glossary/load-balancing" rel="noopener noreferrer">load balancers</a> that distribute requests from the client among multiple servers. A load balancer is a <a target="_blank" href="https://en.wikipedia.org/wiki/Proxy_server#Web_proxy_servers" rel="noopener noreferrer">proxy server</a>, an intermediary server that sits between client and server. To pass information from client to server, we need to make the server trust the proxy server. We only need to do so in our production environment: </p>
<pre><code><span class="hljs-keyword">if</span> (!dev) {
  <span class="hljs-keyword">server</span>.<span class="hljs-keyword">set</span>(<span class="hljs-string">'trust proxy'</span>, <span class="hljs-number">1</span>);
}</code></pre><p>The snippet of code above ensures that our server trusts its immediate proxy. Once set, the client can pass the following information to the server via a proxy server:</p>
<ul>
<li><code>req.hostname</code> inside the <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host" rel="noopener noreferrer">X-Forwarded-Host</a> header</li>
<li><code>req.protocol</code> inside the <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto" rel="noopener noreferrer">X-Forwarded-Proto</a> header</li>
<li><code>req.ip</code> inside the <a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For" rel="noopener noreferrer">X-Forwarded-For</a> header</li>
</ul>
<p>If we don't set <code>server.set('trust proxy', 1);</code>, then our server will see the IP address of the proxy server as the IP address of the <em>client</em>.</p>
</li>
</ul>
<ul>
<li><p>In this step, we set a production-only <a target="_blank" href="https://github.com/expressjs/session#cookiesecure" rel="noopener noreferrer">cookie.secure</a> setting for session:</p>
<pre><code><span class="hljs-keyword">if</span> (!dev) {
  sess.cookie.<span class="hljs-attr">secure</span> = <span class="hljs-literal">true</span>;
}</code></pre><p>Our app will set <code>cookie</code> only when the client accesses the app via HTTPS protocol. Our app won't set <code>cookie</code> if the client used HTTP.</p>
<p>Combine this <code>cookie</code> setting with the <code>trust proxy</code> setting, and you get:</p>
<pre><code><span class="hljs-keyword">if</span> (!dev) {
  <span class="hljs-keyword">server</span>.<span class="hljs-keyword">set</span>(<span class="hljs-string">'trust proxy'</span>, <span class="hljs-number">1</span>);
  sess.cookie.secure = <span class="hljs-keyword">true</span>;
}</code></pre></li>
</ul>
<p>Add the above code snippet right before the <code>server.use(session(sess));</code> line of code in your <code>server/app.js</code> file.</p>
<h4 style="color: #FFF;">
        <a name="seo" href="#seo" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        SEO
      </h4><p>This step is optional, but if you want better SEO, you can provide extra information to search engine bots that index your website. There are two ways to provide information to indexing bots:</p>
<ul>
<li><code>sitemap.xml</code> (placed at <code>/sitemap.xml</code>),</li>
<li><code>robots.txt</code> (placed at <code>/robots.txt</code>).</li>
</ul>
<p>Inside <code>sitemap.xml</code>, you specify which routes to index (<code>url</code>), how often to index them (<code>changefreq</code>), and how important each one is to index (<code>priority</code>).</p>
<p>Inside <code>robots.txt</code>, you can create disallow rules, which specify routes that indexing bots should not crawl.</p>
<p>Let's discuss the content of each file:</p>
<ul>
<li><p>To generate content for <code>sitemap.xml</code>, we use a third party package <a target="_blank" href="https://github.com/ekalinin/sitemap.js" rel="noopener noreferrer">sitemap</a> that you installed at the beginning of this chapter. We will follow the <a target="_blank" href="https://github.com/ekalinin/sitemap.js#example-of-using-sitemapjs-with-express" rel="noopener noreferrer">official example for an Express server</a>:</p>
<pre><code>var sm = require(<span class="hljs-string">'sitemap'</span>);

var sitemap = sm.createSitemap ({
<span class="hljs-symbol">  hostname:</span> <span class="hljs-string">'http://example.com'</span>,
<span class="hljs-symbol">  cacheTime:</span> <span class="hljs-number">600000</span>,        <span class="hljs-comment">// 600 sec - cache purge period</span>
<span class="hljs-symbol">  urls:</span> [
    { <span class="hljs-string">url:</span> <span class="hljs-string">'/page-1/'</span>,  <span class="hljs-string">changefreq:</span> <span class="hljs-string">'daily'</span>, <span class="hljs-string">priority:</span> <span class="hljs-number">0.3</span> },
    { <span class="hljs-string">url:</span> <span class="hljs-string">'/page-2/'</span>,  <span class="hljs-string">changefreq:</span> <span class="hljs-string">'monthly'</span>,  <span class="hljs-string">priority:</span> <span class="hljs-number">0.7</span> },
    { <span class="hljs-string">url:</span> <span class="hljs-string">'/page-3/'</span>},    <span class="hljs-comment">// changefreq: 'weekly',  priority: 0.5</span>
    { <span class="hljs-string">url:</span> <span class="hljs-string">'/page-4/'</span>,   <span class="hljs-string">img:</span> <span class="hljs-string">"http://urlTest.com"</span> }
  ]
});

app.get(<span class="hljs-string">'/sitemap.xml'</span>, function(req, res) {
  sitemap.toXML( function (err, xml) {
      <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).end();
      }
      res.header(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/xml'</span>);
      res.send( xml );
  });
});</code></pre><p>In our web app, the most important pages to crawl are chapters that are located at the <code>/books/builder-book/${chapter.slug}</code> route for our book with the slug <code>builder-book</code>. Take a look at the address bar of this page to see an example of that route. In the above example, objects inside the <code>urls</code> are manually added. However, we want to add the <code>urls</code> to our sitemap automatically from our database. Let's use the Chapter model and Mongoose method/query <code>find()</code> to find all chapters in our database:</p>
<pre><code><span class="hljs-selector-tag">Chapter</span><span class="hljs-selector-class">.find</span>({}, <span class="hljs-string">'slug'</span>)<span class="hljs-selector-class">.then</span>((chapters) =&gt; {
  <span class="hljs-selector-tag">chapters</span><span class="hljs-selector-class">.forEach</span>((chapter) =&gt; {
    <span class="hljs-selector-tag">sitemap</span><span class="hljs-selector-class">.add</span>({
      <span class="hljs-attribute">url</span>: <span class="hljs-built_in">`/books/builder-book/${chapter.slug}`</span>,
      <span class="hljs-attribute">changefreq</span>: <span class="hljs-string">'daily'</span>,
      <span class="hljs-attribute">priority</span>: <span class="hljs-number">1</span>,
    });
  });
});</code></pre><p>Important note - if you have multiple books in your database, you should modify this code. For example, instead of fetching <em>all</em> chapter documents from the database, find chapters by <code>bookId</code> for each book and set the proper book slug in the route for the <code>url</code> parameter.</p>
</li>
<li><p>Create a <code>static/robots.txt</code> file with the following content:</p>
<pre><code>User-<span class="hljs-string">agent:</span> *
<span class="hljs-string">Allow:</span> <span class="hljs-regexp">/books/</span>builder-book/
<span class="hljs-string">Disallow:</span> /admin</code></pre><p>These rules tell all indexing bots (<code>User-agent: *</code>) to crawl all routes under <code>/books/builder-book/</code> but disallow crawling under the <code>/admin</code> route.</p>
<p>In Express, we use the <a target="_blank" href="http://expressjs.com/en/api.html#res.sendFile" rel="noopener noreferrer">res.sendFile()</a> method to serve files from a particular path:</p>
<pre>res.sendFile(path.join(__dirname, '../static', 'robots.txt'));</pre>

<p>By now, you know how to write an Express route with the <code>GET</code> method:</p>
<pre><code>server.get('/robots.txt',<span class="hljs-function"> (<span class="hljs-params">req</span>, <span class="hljs-params">res</span>) =&gt;</span> {
  res.send<span class="hljs-constructor">File(<span class="hljs-params">path</span>.<span class="hljs-params">join</span>(<span class="hljs-params">__dirname</span>, '..<span class="hljs-operator">/</span><span class="hljs-params">static</span>', '<span class="hljs-params">robots</span>.<span class="hljs-params">txt</span>')</span>);
});</code></pre></li>
</ul>
<p>We are done with the <code>sitemap.xml</code> and <code>robots.txt</code> files. The only remaining step is to add routes to our Express server. Let's combine the Express routes under one function <code>setup()</code>, export this function, and import it to <code>server/app.js</code>. </p>
<p>Put together all the code discussed above. Keep in mind the following:</p>
<ul>
<li>in the sitemap example above, replace all instances of <code>app</code> to <code>server</code> (since we defined our Express server as <code>server</code> inside <code>server/app.js</code>)</li>
<li><code>hostname</code> is <code>https://builderbook.org</code></li>
<li>instead of writing <code>urls</code> manually, we do it with <code>Chapter.find()</code></li>
<li>remember to add the <code>/robots.txt</code> Express route</li>
<li>remember to import <code>sitemap</code> and <code>path</code> (<code>path</code> is a Node module; it is not listed in the <code>package.json</code> file)</li>
</ul>
<p>You will get:</p>
<pre><code><span class="hljs-keyword">const</span> sm = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sitemap'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> Chapter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./models/Chapter'</span>);

<span class="hljs-keyword">const</span> sitemap = sm.createSitemap({
  hostname: <span class="hljs-string">'https://builderbook.org'</span>,
  cacheTime: <span class="hljs-number">600000</span>, <span class="hljs-comment">// 600 sec - cache purge period</span>
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup</span>(<span class="hljs-params">{ server }</span>) </span>{
  Chapter.find({}, <span class="hljs-string">'slug'</span>).then(<span class="hljs-function">(<span class="hljs-params">chapters</span>) =&gt;</span> {
    chapters.forEach(<span class="hljs-function">(<span class="hljs-params">chapter</span>) =&gt;</span> {
      sitemap.add({
        url: <span class="hljs-string">`/books/builder-book/<span class="hljs-subst">${chapter.slug}</span>`</span>,
        changefreq: <span class="hljs-string">'daily'</span>,
        priority: <span class="hljs-number">1</span>,
      });
    });
  });

  server.get(<span class="hljs-string">'/sitemap.xml'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    sitemap.toXML(<span class="hljs-function">(<span class="hljs-params">err, xml</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) {
        res.status(<span class="hljs-number">500</span>).end();
        <span class="hljs-keyword">return</span>;
      }

      res.header(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/xml'</span>);
      res.send(xml);
    });
  });

  server.get(<span class="hljs-string">'/robots.txt'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    res.sendFile(path.join(__dirname, <span class="hljs-string">'../static'</span>, <span class="hljs-string">'robots.txt'</span>));
  });
}

<span class="hljs-built_in">module</span>.exports = setup;</code></pre><p>Put this code into a new <code>server/sitemapAndRobots.js</code> file. </p>
<p>Update <code>server/app.js</code> in the following ways:</p>
<ul>
<li>import <code>sitemapAndRobots</code>:<pre>const sitemapAndRobots = require('./sitemapAndRobots');</pre></li>
<li>under the line with <code>routesWithSlug({ server, app });</code>, add this new line:<pre>sitemapAndRobots({ server });</pre>

</li>
</ul>
<p>Start your app with <code>yarn dev</code>. Check out the <code>/sitemap.xml</code> and <code>/robots.txt</code> routes! For example, in our case, the <code>/sitemap.xml</code> route shows the <code>sitemap.xml</code> file:<br><img src="https://user-images.githubusercontent.com/10218864/37223674-1f5d04a0-2386-11e8-9286-915bf0030854.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>You can make sure that Google bots find <code>sitemap.xml</code> and <code>robots.txt</code> at <a target="_blank" href="https://www.google.com/webmasters/tools/home?hl=en" rel="noopener noreferrer">Search Console</a>.</p>
<h4 style="color: #FFF;">
        <a name="now-v1-is-depreciated-" href="#now-v1-is-depreciated-" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Now (V1 is depreciated)
      </h4><p><b>IMPORTANT: Now v1 is depreciated by Zeit. This subsection is no longer relevant since Now v1 is depreciated. There are no plans to add a subsection about Now v2. Please skip to the next section (Heroku) to learn about deploying your app to Heroku.</b></p>
<p>At this point, we've prepared our app for production and are  ready to deploy. You will learn how to deploy your app with <a target="_blank" href="https://zeit.co/now" rel="noopener noreferrer">Now by Zeit</a>. <code>Now</code> is a command-line interface tool that allows you to deploy a JavaScript app in under a minute and with one command, <code>now</code>. This tool will definitely make you more productive. It's built by <code>Zeit</code> on top of AWS and GCP infrastructure.</p>
<p>In this subsection, we will discuss some features of <code>Now</code>. For a list of all features, check out the <a target="_blank" href="https://zeit.co/docs" rel="noopener noreferrer">official documentation</a>.</p>
<p>We will discuss the following topics in this subsection:</p>
<ol>
<li>installing <code>Now</code></li>
<li>first deployment</li>
<li>frozen state and scale</li>
<li>logs, source</li>
<li>adding custom domain</li>
<li>useful commands</li>
</ol>
<ol>
<li><p>To install <code>Now</code>, run: </p>
<pre>npm install -g now</pre>
<p>To see all available commands (this confirms that you installed <code>Now</code>):</p>
<pre>now help</pre>
<p>Attempt running:</p>
<pre>now</pre>

<p>This will produce an error and ask you to sign up for Zeit and click a verification link inside an email from Zeit.</p>
<p>After you click the verification link, you will be able to deploy and use the rest of the <code>Now</code> commands.</p>
</li>
<li><p>Create a <code>now.json</code> file at the root of your app folder. File content:</p>
<pre><code>{
 <span class="hljs-attr">"version"</span>: <span class="hljs-number">1</span>,
 <span class="hljs-attr">"env"</span>: {
     <span class="hljs-attr">"NODE_ENV"</span>: <span class="hljs-string">"production"</span>,
     <span class="hljs-attr">"StripePublishableKey"</span>: <span class="hljs-string">"pk_live_xxxxxx"</span>

 },

 <span class="hljs-attr">"dotenv"</span>: <span class="hljs-literal">true</span>
}</code></pre><p>The first parameter sets <code>NODE_ENV</code>, and the second parameter tells <code>Now</code> that our app uses the <code>dotenv</code> dependency and that our environmental variables are in a <code>.env</code> file.</p>
<p>Since you set <code>NODE_ENV</code> to <code>production</code> in <code>now.json</code>, you can remove <code>NODE_ENV=production</code> from the <code>build</code> script in your <code>package.json</code> file.</p>
<p>Remember to add your <em>live</em> publishable key from Stripe (<code>pk_live_xxxxxx</code>) to <code>now.json</code>. This will ensure that your <code>StripePublishableKey</code> value is available on both client and server. As you know by now, all environmental variables inside <code>.env</code> are avaiable on the server only. When you run your app locally, you use your <em>test</em> publishable key <code>pk_test_xxxxxx</code> and run the app with  <code>StripePublishableKey=pk_test_xxxxxx yarn dev</code>.</p>
<p>In your terminal, navigate to the root directory of your app.<br>Deploy your app with this command:</p>
<pre>now</pre>

<p><code>Now</code> will:</p>
<ul>
<li>upload code</li>
<li>install dependencies from <code>yarn.lock</code></li>
<li>run <code>npm build</code></li>
<li>run <code>npm start</code></li>
<li>automatically re-start server if it stopped running</li>
</ul>
<p>The terminal prints out all events:<br><img src="https://user-images.githubusercontent.com/10218864/37228004-fb690c8e-2393-11e8-9b2e-f9046ca8c7c4.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Access your deployment at the URL provided by <code>Now</code>. In our case, it's:</p>
<pre>&gt; Ready! https://8-end-lpbrrsahsc.now.sh</pre>
<p>On our browser:<br><img src="https://user-images.githubusercontent.com/10218864/37228050-2c52b6ce-2394-11e8-94ba-98b00b2445ec.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>This URL is publicly accessible but has a randomly-generated and hard-to-guess part, <code>lpbrrsahsc</code>.</p>
<p>The name of deployment is the same as a name inside <code>package.json</code> file.</p>
<p>Important note - <code>Now</code> will upload all files from your app root directory. Tell <code>Now</code> to ignore any file or folder by adding its name to a <code>.npmignore</code> file. More on this in <a target="_blank" href="https://zeit.co/docs/features/now-cli#selecting-files-and-directories-to-be-uploaded" rel="noopener noreferrer">Now's docs</a>.</p>
</li>
<li><p>Your newly created deployment will go into a <code>frozen</code> state if it does not get any requests. Run:</p>
<pre>now scale ls</pre>

<p>Output:</p>
<pre><code>url                                           cur      min      max     <span class="hljs-built_in">auto</span>      age
<span class="hljs-number">8</span>-end-lpbrrsahsc.now.sh                         <span class="hljs-number">1</span>        <span class="hljs-number">0</span>        <span class="hljs-number">1</span>        ✔       <span class="hljs-number">9</span>m</code></pre><p>Scale number indicates number of live instances of deployment. The value at <code>min</code> equals 0, this means that the deployment will go into a <code>frozen</code> state. To start <code>frozen</code> deployment, you have to visit it and wait for 10-20 seconds.</p>
<p>To keep deployment alive, even when your app receives no traffic, you have to scale it to 1 or more instances:</p>
<pre>now scale https://8-end-lpbrrsahsc.now.sh 1</pre>

<p>If you want to deploy to 2 or more instances <em>automatically</em> when your app gets more traffic, run:</p>
<pre>now scale https://8-end-lpbrrsahsc.now.sh 1 2 auto</pre>

<p>Check the <a target="_blank" href="https://zeit.co/docs/getting-started/scaling" rel="noopener noreferrer">scaling docs</a> for more features.</p>
</li>
<li><p>Go to <code>https://zeit.co/dashboard</code>. You will see something like:<br><img src="https://user-images.githubusercontent.com/10218864/37228712-601c2a9c-2396-11e8-98af-660a0563c96e.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Click the hyperlinked deployment URL, and you will be redirected to a deployment overview page:<br><img src="https://user-images.githubusercontent.com/10218864/37228783-a4cdd190-2396-11e8-9036-92c468a26112.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Click on <code>Logs</code> and <code>Source</code>:<br><img src="https://user-images.githubusercontent.com/10218864/37228843-d928eb8c-2396-11e8-8967-dceb8d8b75bb.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p><img src="https://user-images.githubusercontent.com/10218864/37228852-e21412da-2396-11e8-87da-a97387f061e3.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p>Both the production logs and deployment's actual code are useful for debugging.</p>
</li>
<li><p>The URL of our deployment is not memorable. It simply allows you to deploy an app and test it out before mapping it to an actual, memorable domain.<br>One way to create a more memorable URL is:</p>
<pre>now ln 8-end-lpbrrsahsc.now.sh builderbook.now.sh</pre>

<p>Now we can access our deployment at <code>https://builderbook.now.sh</code>.</p>
<p>Another (more common) way is to point your deployment to a custom domain. Run this (remember to use <em>your</em> actual domain):</p>
<pre>now ln 8-end-lpbrrsahsc.now.sh test.builderbook.org</pre>

<p>Now we can access our deployment at <code>https://test.builderbook.org</code>.</p>
<p>If the <code>now ln</code> command produces an error, then you need to either add <code>CNAME</code> to your domain records or add a domain to <a target="_blank" href="https://zeit.co/world" rel="noopener noreferrer">zeit.world</a>. Here is a <a target="_blank" href="https://zeit.co/docs/getting-started/assign-a-domain-name" rel="noopener noreferrer">link</a> with instructions for either case.</p>
</li>
<li><p>You do not pay for deployments that are in a <code>frozen</code> state. The cool part about the <code>now ln</code> command is that a newly aliased deployment will <em>assume</em> the scale settings of a previous deployment that was aliased to the same custom domain. At the same time, the old deployment will become <code>frozen</code>. For example, if the scale setting for our domain <code>test.builderbook.org</code> is <code>1 2 auto</code> and then we alias a new deployment to this domain, the new deployment will get <code>1 2 auto</code> settings automatically. Our old deployment, which got un-aliased, will get <code>0 1 auto</code> settings and will go into a <code>frozen</code> state.</p>
<p>As a consequence, you will accumulate many <code>frozen</code> deployments. To reduce clutter, you can remove them with:</p>
<pre>now rm 8-end-lpbrrsahsc.now.sh</pre>

<p>If you don't like the <code>Are you sure?</code> step, run:</p>
<pre>now rm 8-end-lpbrrsahsc.now.sh -y</pre>

<p>If you like to remove <em>all</em> deployments with a particular name that <em>are not</em> aliased, use:</p>
<pre>now rm 8-end --safe -y</pre>

<p>The above command will remove all deployments that have the name <code>8-end</code> accept deployment that is aliased.</p>
</li>
</ol>
<p><b>IMPORTANT: Now v1 is depreciated by Zeit. This subsection is no longer relevant since Now v1 is depreciated. There are no plans to add a subsection about Now v2. Please skip to the next section (Heroku) to learn about deploying your app to Heroku.</b></p>
<h4 style="color: #FFF;">
        <a name="heroku" href="#heroku" style="color: #FFF;">
          <i class="material-icons" style="vertical-align: middle; opacity: 0.5; cursor: pointer; color: FFF;">
              link
            </i>
        </a>
        Heroku
      </h4><p>In this last subsection of the book we will learn how to deploy our app to <a target="_blank" href="https://www.heroku.com/home" rel="noopener noreferrer">Heroku cloud</a>. We will deploy our Next-Express app to lightweight Heroku container called <a target="_blank" href="https://www.heroku.com/dynos" rel="noopener noreferrer">dyno</a>.</p>
<p>We will discuss the following topics in this subsection:</p>
<ol>
<li>installing Heroku on Linux-based OS</li>
<li>creating app on Heroku dashboard</li>
<li>preparing app for deployment</li>
<li>configuring env variables</li>
<li>deploying app</li>
<li>checking logs</li>
<li>adding custom domain</li>
</ol>
<p>Let's go step by step.</p>
<ol>
<li><p>Install Heroku CLI (command-line interface) on your OS. Follow the <a target="_blank" href="https://devcenter.heroku.com/articles/heroku-cli" rel="noopener noreferrer">official guide</a>. In this book we provide instructions for Linux-based systems, in particular, a Ubuntu OS. For Ubuntu OS, run in your terminal:</p>
<pre>sudo snap install --classic heroku</pre>
<p>To confirm a successful installation, run:</p>
<pre>heroku --version</pre>
<p>As example, my output that confirms successful installation, looks like:</p>
<pre>heroku/7.22.7 linux-x64 node-v11.10.1</pre>
</li>
<li><p><a target="_blank" href="https://signup.heroku.com/" rel="noopener noreferrer">Sign up</a> for Heroku, go to your Heroku dashboard and click purple <b>New</b> button on the right:<br><img src="https://user-images.githubusercontent.com/10218864/54558094-12b1f100-497a-11e9-94dd-d36399052931.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> On the next screen, give a name to your app and select a region. Click purple <b>Create app</b> button at the bottom:<br> <img src="https://user-images.githubusercontent.com/10218864/54558276-8eac3900-497a-11e9-9026-25aa5047af87.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> You will be redirected to <code>Deploy</code> tab of your newly created Heroku app:<br> <img src="https://user-images.githubusercontent.com/10218864/54558544-417c9700-497b-11e9-8885-6fdfde21c747.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
</li>
<li><p>As you can see from the above screenshot, you have two options. You can deploy the app directly from your local machine using Heroku CLI or directly from GitHub.<br> In this tutorial, we will deploy a <code>builderbook/builderbook/book/8-end</code> app from our public <a target="_blank" href="https://github.com/builderbook/builderbook" rel="noopener noreferrer">builderbook/builderbook</a> repo hosted on GitHub. Deploying from a private repo will be a similar process.</p>
<p> Deploying from GitHub has a few advantages. Heroku uses git to track changes in a codebase. It's possible to deploy app from the local machine using Heroku CLI, however you have to create a <a target="_blank" href="https://git-scm.com/book/en/v2/Git-Basics-Getting-a-Git-Repository" rel="noopener noreferrer">Git repo</a> for <code>builderbook/builderbook/book/8-end</code> with <code>package.json</code> file at the root level. A first advantage is that we can deploy from a non-root folder using GitHub instead of Heroku CLI.</p>
<p> A second advantage is automation, later on you can create a branch that automatically deploy every new commit to Heroku. For example, we have a <a target="_blank" href="https://github.com/async-labs/saas/tree/deploy" rel="noopener noreferrer">deploy branch</a> for our demo for <a target="_blank" href="https://github.com/async-labs/saas/" rel="noopener noreferrer">SaaS boilerplate</a>. When we commit to <code>master</code> branch - there is no new deployment, when we commit to <code>deploy</code> branch - new change is automatically deployed to Heroku app.</p>
<p> Let's set up deploying from GitHub. On <code>Deploy</code> tab of your Heroku app at Heroku dashboard, click <b>Connect to GitHub</b>, then search for your repo, then click <b>Connect</b> next to the name of the proper repo:<br> <img src="https://user-images.githubusercontent.com/10218864/54560210-09775300-497f-11e9-9027-2e3850ec7ff1.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> If successful, you will see green text <code>Connected</code> and be offered to select a branch and deploy app automatically or manually. Automatic deployment will deploy every new commit, manual deployment requires you to manually click on <b>Deploy Branch</b> button. For simplicity, we will deploy manually from <code>master</code> branch of our <code>builderbook/builderbook</code> repo.</p>
<p> Before we perform a manual deployment via GitHub, we need Heroku to run some additional code while app is being deploying. Firstly, we need to tell Heroku that <code>8-end</code> app in the <code>builderbook/builderbook</code> repo is not at the root level, it's actually nested at <code>/book/8-end</code>. Secondly, Heroku needs to know that our app is Node.js app so Heroku finds <code>package.json</code> file, properly installs dependencies and runs proper scripts (such as <code>build</code> and <code>start</code> scripts from <code>package.json</code>). To achieve this, we need to add so called <code>buildpacks</code> to our Heroku app. Click <code>Settings</code> tab, scroll to <code>Buildpacks</code> section and click purple <b>Add buildpack</b> button:<br> <img src="https://user-images.githubusercontent.com/10218864/54561192-50fede80-4981-11e9-976a-c3d7c88527ec.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> Add two buildpacks, first is <code>https://github.com/timanovsky/subdir-heroku-buildpack</code> and second is <code>heroku/nodejs</code>:<br> <img src="https://user-images.githubusercontent.com/10218864/54561577-30835400-4982-11e9-997f-4711d999808e.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> Next, scroll up while on <code>Settings</code> tab and click purple <b>Reveal Config Vars</b> button, create a new environmental variable <code>PROJECT_PATH</code> with value <code>book/8-end</code>:<br> <img src="https://user-images.githubusercontent.com/10218864/54561775-a5568e00-4982-11e9-9561-2e5827873779.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> The above variable will be used by the first buildpack <code>subdir-heroku-buildpack</code> to deploy app from repo's subdirectory.</p>
</li>
<li><p>If we deploy app at this point, our app will deploy with errors since we did not add environmental variables. Similar to how you added <code>PROJECT_PATH</code> variable, add all environmental variables from <code>book/8-end/.env</code> file to your Heroku app. Remember to add:</p>
<ul>
<li><code>MONGO_URL</code>,</li>
<li><code>Google_clientID</code>, </li>
<li><code>Google_clientSecret</code>,</li>
<li><code>EMAIL_SUPPORT_FROM_ADDRESS</code>,</li>
<li><code>Github_Test_ClientID</code>,</li>
<li><code>Github_Test_SecretKey</code>,</li>
<li><code>Github_Live_ClientID</code>,</li>
<li><code>Github_Live_SecretKey</code>,</li>
<li><code>Stripe_Test_SecretKey</code>,</li>
<li><code>Stripe_Live_SecretKey</code>,</li>
<li><code>MAILCHIMP_API_KEY</code>,</li>
<li><code>MAILCHIMP_PURCHASED_LIST_ID</code>,</li>
<li><code>SESSION_SECRET</code>.</li>
</ul>
</li>
</ol>
<ol start="5">
<li><p>While on <code>Settings</code> tab, scroll to <code>Domains and certificates</code> section and note your app's URL. My app's URL is: <a target="_blank" href="https://builderbook-8-end.herokuapp.com" rel="noopener noreferrer">https://builderbook-8-end.herokuapp.com</a><br> Let's deploy, go to <code>Deploy</code> tab, scroll to <code>Manual deploy</code> section and click <b>Deploy branch</b> button.<br> After deployment process is complete , navigate to your app's URL:<br> <img src="https://user-images.githubusercontent.com/10218864/54564053-10569380-4988-11e9-87dd-f81a28dd6406.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
</li>
<li><p>Server logs are not available on Heroku dashboard. To see logs, you have to use Heroku CLI.<br> In your terminal, run:</p>
 <pre>heroku login</pre>

<p> Follow instructions to log in to Heroku CLI.</p>
<p> After successful login, terminal will print:</p>
 <pre>Logged in as email@domain.com</pre>

<p> Where <code>email@domain.com</code> is an email address that you used to create your Heroku account.</p>
<p> To see logs, in your terminal run:</p>
 <pre>heroku logs --app builderbook-8-end --tail</pre>

<p> In your terminal, you will see your most recent logs and be able to see a real-time logs. </p>
<p> You can output certain number of lines (N) for retrieved logs by adding <code>--num N</code> to the <code>heroku logs</code> command.<br> You can print only app's logs by adding <code>--source app</code> or system's logs by adding <code>--source heroku</code>.  </p>
</li>
<li><p>Time to add a custom domain. The Heroku app that we created is deployed on <code>free dyno</code>. Free dyno plan does not let you to add a custom domain to your app. To add custom domain, go to <code>Resources</code> tab and click purple <b>Change Dyno Type</b> button:<br> <img src="https://user-images.githubusercontent.com/10218864/54622849-983faa80-4a27-11e9-957f-54fe5aa742ca.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> Select a <code>Hobby</code> plan and click <b>Save</b> button.</p>
<p> Navigate to <code>Settings</code> tab and scroll to the <code>Domains and certificates</code> and click purple <b>Add domain</b> button:<br> <img src="https://user-images.githubusercontent.com/10218864/54623152-36cc0b80-4a28-11e9-974b-8a14fb56a86a.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
<p> Type your custom domain name, I added <code>heroku.builderbook.org</code> as a custom domain, click <b>Save changes</b> button.</p>
<p> Heroku will displa you a value for CNAME record that you have to create for your custom domain. For me, custom domain is `heroku.builderbook.org and I manage DNS records at Now by Zeit.</p>
<p> After you create a CNAME, ACM status on Heroku's dashboard will change to <code>Ok</code>:<br> <img src="https://user-images.githubusercontent.com/10218864/54624195-2452d180-4a2a-11e9-999d-a6a771cde73c.png" style="border: 1px solid #ddd;" width="100%" alt="Builder Book"></p>
</li>
</ol>
<p>It's important that you remember to manually add your custom domain to the settings of your Google OAuth app (Chapter 3) and GitHub OAuth app (Chapter 6). If you forget to do it, you will see errors when you try to log in to your app or when you try to connect GitHub to your app.</p>
<hr>
<p>This was the last subsection of the last section in the last chapter of this book.<br>If you got this far - wow, this is the end of the book!</p>
<p>We hope that you learned a lot and that you glued many concepts together while building this web application.</p>
<p>By now, you should answer this question from the Introduction chapter with a <a target="_blank" href="https://youtu.be/fcbj8BBsWSA?t=66" rel="noopener noreferrer">resounding Yes</a> :</p>
<pre>Have you ever built a production-ready web application from scratch by yourself?</pre>

<p>If you have any questions or feedback, feel free to create an issue at:<br><a target="_blank" href="https://github.com/builderbook/builderbook/issues" rel="noopener noreferrer">https://github.com/builderbook/builderbook/issues</a></p>
<p>To give a review of our book, please fill out this form:<br><a target="_blank" href="https://goo.gl/forms/JdevtnCWsLwZTAio2" rel="noopener noreferrer">https://goo.gl/forms/JdevtnCWsLwZTAio2</a></p>
<hr>
<p>At the end of Chapter 8, your codebase should look like the codebase in <code>8-end</code>. The <a target="_blank" href="https://github.com/builderbook/builderbook/tree/master/book/8-end" rel="noopener noreferrer">8-end</a> folder is located at the root of the <code>book</code> directory inside the <a target="_blank" href="https://github.com/builderbook/builderbook" rel="noopener noreferrer">builderbook repo</a>.</p>
<p>Compare your codebase and make edits if needed.</p>
<hr>
<br>
</div></div>